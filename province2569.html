<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <title>CDD Women Fund Province 2569</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css" />

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            margin: 0;
            background: linear-gradient(to bottom right, #fce4ec, #f3e5f5);
            color: #000;
        }

        .dashboard-container {
            padding: 40px;
            background-color: rgba(255, 255, 255, 0.95);
            width: 100%;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .header-text h1 {
            margin: 0;
            font-size: 2.5rem;
        }

        .header-text h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .cards {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .card {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
        }

        .card .value {
            font-size: 1.75rem;
            color: black;
            margin-top: 10px;
            font-weight: normal;
            white-space: nowrap;
        }

        .pink {
            background-color: #e91e63;
        }

        .light-pink {
            background-color: #f8bbd0;
        }

        .orange {
            background-color: #ff9800;
        }

        .deep-pink {
            background-color: #f06292;
        }

        table.dataTable {
            width: 100% !important;
            border-collapse: collapse;
            font-size: 0.85rem;
            color: black;
        }

        table.dataTable th,
        table.dataTable td {
            border: 1px solid #ccc;
            padding: 4px 6px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
        }

        table.dataTable thead th {
            background-color: #f06292;
            color: black;
            font-weight: bold;
        }

        .filter-container {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            gap: 15px;
            padding: 15px;
            background-color: #f8bbd0;
            border-radius: 8px;
            margin-bottom: 20px;
            margin-top: 20px;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            min-width: 160px;
            flex-grow: 1;
        }

        .filter-item label {
            font-weight: bold;
            font-size: 0.8rem;
            margin-bottom: 4px;
            color: #333;
        }

        .filter-item select {
            width: 100%;
            padding: 6px;
            border: 1px solid #aaa;
            border-radius: 4px;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.85rem;
            height: 35px;
        }

        .action-button-container {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 6px 15px;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        #btnResetFilter {
            background-color: #d9534f;
        }

        #btnDownload {
            background-color: #5cb85c;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div class="header">
            <div class="header-text">
                <h1><span style="color:navy;">CDD</span> <span style="color:deeppink;">Women</span> <span
                        style="color:red;">Fund</span></h1>
                <h2><span style="color:black;">รายจังหวัด:</span> <span style="color:red;" id="province-title"></span>
                </h2>
            </div>

            <div class="logo-container">
                <img src="https://i.postimg.cc/507bjy9Z/cdd.png" width="60" height="100" />
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZtkPBp_xmIFgEEmX2cyScE1QzabzZbtNdbQ&s"
                    width="70" height="100" />
            </div>
        </div>

        <div style="text-align:right;font-weight:bold;color:navy;margin-top:1rem;font-size:1.2rem;">
            <span id="update-date">ข้อมูล ณ วันที่ -</span>
        </div>

        <!-- Summary Cards -->
        <div class="row g-3">

    <!-- โครงการทั้งหมด -->
    <div class="col-md-3">
        <div class="card text-white bg-primary shadow-sm">
            <div class="card-body">
                <h6 class="card-title">จำนวนโครงการทั้งหมด</h6>
                <h3 id="num-projects" class="fw-bold">0</h3>
            </div>
        </div>
    </div>

    <!-- เงินอนุมัติ -->
    <div class="col-md-3">
        <div class="card text-white bg-info shadow-sm">
            <div class="card-body">
                <h6 class="card-title">เงินอนุมัติ</h6>
                <h3 id="approved-money" class="fw-bold">0</h3>
            </div>
        </div>
    </div>

    <!-- ลูกหนี้ต้นปี -->
    <div class="col-md-3">
        <div class="card text-white bg-secondary shadow-sm">
            <div class="card-body">
                <h6 class="card-title">ลูกหนี้คงเหลือ ณ 1 ต.ค. 2568 (A)</h6>
                <h3 id="debt-start" class="fw-bold">0</h3>
            </div>
        </div>
    </div>

    <!-- ลูกหนี้ปัจจุบัน -->
    <div class="col-md-3">
        <div class="card text-white bg-dark shadow-sm">
            <div class="card-body">
                <h6 class="card-title">ลูกหนี้คงเหลือปัจจุบัน (ก)</h6>
                <h3 id="debt-now" class="fw-bold">0</h3>
            </div>
        </div>
    </div>

    <!-- หนี้เกินกำหนด -->
    <div class="col-md-3">
        <div class="card text-white bg-danger shadow-sm">
            <div class="card-body">
                <h6 class="card-title">หนี้เกินกำหนดชำระ (B)</h6>
                <h3 id="overdue" class="fw-bold">0</h3>
            </div>
        </div>
    </div>

    <!-- เปอร์เซ็นต์หนี้เกินกำหนด -->
    <div class="col-md-3">
        <div class="card text-white bg-warning shadow-sm">
            <div class="card-body">
                <h6 class="card-title">% หนี้เกินกำหนด</h6>
                <h3 id="percent-overdue" class="fw-bold">0%</h3>
            </div>
        </div>
    </div>

    <!-- ดำเนินการตามกฎหมาย (ง) -->
    <div class="col-md-3">
        <div class="card text-white bg-success shadow-sm">
            <div class="card-body">
                <h6 class="card-title">ลูกหนี้ดำเนินการตามกฎหมาย (ง)</h6>
                <h3 id="legal" class="fw-bold">0</h3>
            </div>
        </div>
    </div>

    <!-- วันที่อัปเดต -->
    <div class="col-md-3">
        <div class="card bg-light shadow-sm">
            <div class="card-body">
                <h6 class="card-title text-muted">อัปเดตข้อมูลล่าสุด</h6>
                <h5 id="update-date" class="fw-bold">-</h5>
            </div>
        </div>
    </div>

</div>


<!-- =============================================================== -->
<!--              ห นี้ ป รั บ โ ค ร ง ส ร้ า ง ( ค )                -->
<!-- =============================================================== -->

<h5 class="mt-4 fw-bold">หนี้ปรับโครงสร้าง (ค)</h5>

<div class="row g-3">
    <div class="col-md-3">
        <div class="card border-primary shadow-sm">
            <div class="card-body">
                <h6 class="card-title text-primary">จำนวนรายการ</h6>
                <h3 id="restructure-count" class="fw-bold">0</h3>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card border-primary shadow-sm">
            <div class="card-body">
                <h6 class="card-title text-primary">ยอดหนี้ปรับโครงสร้างรวม</h6>
                <h3 id="restructure-sum" class="fw-bold">0</h3>
            </div>
        </div>
    </div>
</div>


<!-- =============================================================== -->
<!--       ห นี้ ที่ ดำ เ นิ น ค ดี แ พ่ ง ( ง 1 – ง 2 )              -->
<!-- =============================================================== -->

<h5 class="mt-4 fw-bold">หนี้ที่อยู่ระหว่างดำเนินคดีแพ่ง (ง1–ง2)</h5>

<div class="row g-3">

    <div class="col-md-3">
        <div class="card border-danger shadow-sm">
            <div class="card-body">
                <h6 class="card-title text-danger">จำนวนรายการ</h6>
                <h3 id="civil-count" class="fw-bold">0</h3>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card border-danger shadow-sm">
            <div class="card-body">
                <h6 class="card-title text-danger">ยอดรวม (ง1 + ง2)</h6>
                <h3 id="civil-sum" class="fw-bold">0</h3>
            </div>
        </div>
    </div>

</div>




    <h3>ตัวกรองข้อมูล</h3>
    <div id="filter-section" class="filter-container"></div>

    <div class="filter-container">
        <div class="filter-item">
            <label for="downloadType">ดาวน์โหลดข้อมูล:</label>
            <select id="downloadType">
                <option value="excel">Excel</option>
            </select>
        </div>
        <div class="action-button-container">
            <button id="btnDownload">ดาวน์โหลด</button>
            <button id="btnResetFilter">ล้างตัวกรอง</button>
        </div>
    </div>

    <h3>ตารางรายละเอียดข้อมูลโครงการรายอำเภอ</h3>
    <table id="detailsTable" class="display" style="width:100%">
        <thead></thead>
        <tbody></tbody>
    </table>
    </div>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwwxjRdiPSd7SOuZAOO5OmWi5NHCBMOf3d1923ik9QBY7iiZ0gJl6ppcQQUHGrxuLRTAg/exec";  // ⭐ ใส่ URL Apps Script ของคุณตรงนี้ ⭐

        let allData = [], dataTable, originalSummary = null;

        const formatNumber = v => isNaN(parseFloat(v)) ? "-" : parseFloat(v).toLocaleString("th-TH", { minimumFractionDigits: 2 });
        const formatPercent = v => isNaN(parseFloat(v)) ? "-" : `${parseFloat(v).toFixed(2)}%`;

        $(document).ready(async function () {
            const province = new URLSearchParams(window.location.search).get("province");
            $("#province-title").text(province || "-");

            $("#btnResetFilter").on("click", () => {
                $("#filter-section select").val("").trigger("change");
                renderTable(allData);
                updateSummaryCards(originalSummary);
            });

            $("#btnDownload").on("click", downloadData);

            await fetchData(province);
        });

        async function fetchData(province) {
            try {
                const res = await fetch(`${API_URL}?province=${encodeURIComponent(province)}`);
                const json = await res.json();

                if (json.error) throw new Error(json.error);

                allData = json.data || [];
                originalSummary = json.summary;

                updateSummaryCards(json.summary);
                renderTable(allData);
                setupFilters(allData);

            } catch (err) {
                alert("เกิดข้อผิดพลาด: " + err.message);
            }
        }

        function renderTable(data) {
            const headers = Object.keys(data[0] || {});
            $("#detailsTable thead").html(`<tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>`);
            const tbody = $("#detailsTable tbody").empty();

            data.forEach(row => {
                tbody.append(`<tr>${headers.map(h => `<td>${row[h] ?? "-"}</td>`).join("")}</tr>`);
            });

            if ($.fn.DataTable.isDataTable("#detailsTable")) {
                $("#detailsTable").DataTable().destroy();
            }

            dataTable = $("#detailsTable").DataTable({ scrollX: true, pageLength: 10 });
        }

        function setupFilters(data) {
            const keys = ["อำเภอ/เขต", "ตำบล", "ปีงบประมาณ", "สถานะโครงการ"];
            const container = $("#filter-section").empty();

            // สร้าง select สำหรับแต่ละ key
            keys.forEach(k => {
                container.append(`
      <div class="filter-item">
        <label>${k}</label>
        <select data-key="${k}">
          <option value="">-- ทั้งหมด --</option>
        </select>
      </div>
    `);
            });

            const selects = $("#filter-section select");

            // เติมค่าเริ่มต้นให้ select
            function updateSelectOptions(filteredData) {
                selects.each(function () {
                    const key = $(this).data("key");
                    const currentVal = $(this).val();

                    let options = [...new Set(filteredData.map(r => r[key]).filter(Boolean))].sort();
                    const html = `<option value="">-- ทั้งหมด --</option>` + options.map(v => `<option value="${v}">${v}</option>`).join("");
                    $(this).html(html);

                    if (options.includes(currentVal)) $(this).val(currentVal);
                });
            }

            // กรองข้อมูลตาม select ทั้งหมด
            function filterData() {
                let filtered = [...allData];

                selects.each(function () {
                    const key = $(this).data("key");
                    const val = $(this).val();
                    if (val) {
                        filtered = filtered.filter(r => r[key] == val);
                    }
                });

                renderTable(filtered); // แสดงเฉพาะข้อมูลที่กรองแล้ว
                updateSummaryFromFiltered(filtered); // อัปเดตการ์ดสรุป

                // อัปเดตตัวเลือก select ให้ตรงกับข้อมูลที่กรอง (dependent)
                updateSelectOptions(filtered);
            }

            // เติมตัวเลือกครั้งแรก
            updateSelectOptions(data);

            // เมื่อ select เปลี่ยน → กรองข้อมูล
            selects.on("change", filterData);
        }



        function updateSummaryCards(s) {
            $("#num-projects").text((s.totalProjects || 0).toLocaleString("th-TH"));
            $("#approved-money").text(formatNumber(s.approvedMoney));
            $("#debt-start").text(formatNumber(s.debtStart));
            $("#debt-now").text(formatNumber(s.debtNow));
            $("#overdue").text(formatNumber(s.overdue));
            $("#legal").text(formatNumber(s.legal));
            $("#percent-overdue").text(formatPercent(s.percentOverdue));
            $("#update-date").text("ข้อมูล ณ วันที่ " + s.updateDate);

            // ⭐ หนี้ปรับโครงสร้าง (ค)
            $("#restructure-count").text((s.restructureCount || 0).toLocaleString("th-TH"));
            $("#restructure-sum").text(formatNumber(s.restructureSum));

            // ⭐ ดำเนินคดีแพ่ง (ง1–ง2)
            $("#civil-count").text((s.civilCount || 0).toLocaleString("th-TH"));
            $("#civil-sum").text(formatNumber(s.civilSum));
        }


        function calculateNormalDebt(data) {
            let filtered = data.filter(r =>
                parseFloat(r["ลูกหนี้คงเหลือ ณ ปัจจุบัน (ก)"]) > 0 &&
                parseFloat(r["หนี้ยังไม่ถึงกำหนดชำระ (ข)"]) > 0 &&
                parseFloat(r["การไกล่เกลี่ยที่สามารถใช้บังคับคดีได้ (ค)"]) == 0 &&
                parseFloat(r["ลูกหนี้ที่ได้ดำเนินการตามกฎหมาย (ง)"]) == 0 &&
                parseFloat(r["จำนวนหนี้ที่เกินกำหนดชำระ (B)"]) == 0
            );

            let count = filtered.length;
            let amount = filtered.reduce(
                (sum, r) => sum + (parseFloat(r["หนี้ยังไม่ถึงกำหนดชำระ (ข)"]) || 0),
                0
            );

            return { count, amount };
        }


        function updateSummaryFromFiltered(data) {
            if (!data || data.length === 0) {

                updateSummaryCards({
                    totalProjects: 0,
                    approvedMoney: 0,
                    debtStart: 0,
                    debtNow: 0,
                    overdue: 0,
                    legal: 0,
                    percentOverdue: 0,
                    updateDate: originalSummary.updateDate,

                    // เพิ่มให้ไม่ error เวลาเคลียร์ filter
                    restructureCount: 0,
                    restructureSum: 0,
                    civilCount: 0,
                    civilSum: 0
                });

                $("#normal-count").text("0");
                $("#normal-amount").text("0");
                return;
            }

            const sum = key =>
                data.reduce((acc, r) => acc + (parseFloat(r[key]) || 0), 0);

            // =============================
            //   ค่าพื้นฐานของ Summary
            // =============================
            const result = {
                totalProjects: data.length,
                approvedMoney: sum("เงินอนุมัติ"),
                debtStart: sum("ลูกหนี้คงเหลือ ณ 1 ต.ค. 2568 (A)"),
                debtNow: sum("ลูกหนี้คงเหลือ ณ ปัจจุบัน (ก)"),
                overdue: sum("จำนวนหนี้ที่เกินกำหนดชำระ (B)"),
                legal: sum("ลูกหนี้ที่ได้ดำเนินการตามกฎหมาย (ง)"),
                percentOverdue: 0,
                updateDate: originalSummary.updateDate
            };

            if (result.debtNow > 0) {
                result.percentOverdue =
                    (result.overdue / result.debtNow) * 100;
            }

            // =============================
            //   หนี้ปกติ (ใช้ฟังก์ชันเดิม)
            // =============================
            const normal = calculateNormalDebt(data);
            $("#normal-count").text(normal.count.toLocaleString("th-TH"));
            $("#normal-amount").text(formatNumber(normal.amount));

            // ======================================================
            //                  ⭐ หนี้ปรับโครงสร้าง (ค) ⭐
            // ======================================================
            const restructItems = data.filter(item =>
                Number(item.k_current_debt) > 0 &&
                Number(item.k_mediation) > 0
            );

            result.restructureCount = restructItems.length;
            result.restructureSum = restructItems.reduce(
                (sum, item) => sum + Number(item.k_mediation),
                0
            );

            // ======================================================
            //    ⭐ หนี้ที่อยู่ระหว่างดำเนินคดีแพ่ง (ง1 – ง2) ⭐
            // ======================================================
            const civilItems = data.filter(item =>
                Number(item.ng1_prosecutor) > 0 ||
                Number(item.ng2_court_accept) > 0
            );

            const civilCount = civilItems.length;
            const sumNg1 = civilItems.reduce(
                (sum, item) => sum + Number(item.ng1_prosecutor),
                0
            );
            const sumNg2 = civilItems.reduce(
                (sum, item) => sum + Number(item.ng2_court_accept),
                0
            );

            result.civilCount = civilCount;
            result.civilSum = sumNg1 + sumNg2;

            // =============================
            //    ส่งขึ้นหน้าจอ
            // =============================
            updateSummaryCards(result);
        }


        function downloadData() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(allData);
            XLSX.utils.book_append_sheet(wb, ws, "Province");
            XLSX.writeFile(wb, `${$("#province-title").text()}_KPI69.xlsx`);
        }
    </script>

</body>

</html>