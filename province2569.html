<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <title>CDD Women Fund Province 2569</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css" />

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            margin: 0;
            background: linear-gradient(to bottom right, #fce4ec, #f3e5f5);
            color: #000;
        }

        .dashboard-container {
            padding: 40px;
            background-color: rgba(255, 255, 255, 0.95);
            width: 100%;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .header-text h1 {
            margin: 0;
            font-size: 2.5rem;
        }

        .header-text h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .cards {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .card {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
        }

        .card .value {
            font-size: 1.75rem;
            color: black;
            margin-top: 10px;
            font-weight: normal;
            white-space: nowrap;
        }

        .pink {
            background-color: #e91e63;
        }

        .light-pink {
            background-color: #f8bbd0;
        }

        .orange {
            background-color: #ff9800;
        }

        .deep-pink {
            background-color: #f06292;
        }

        table.dataTable {
            width: 100% !important;
            border-collapse: collapse;
            font-size: 0.85rem;
            color: black;
        }

        table.dataTable th,
        table.dataTable td {
            border: 1px solid #ccc;
            padding: 4px 6px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
        }

        table.dataTable thead th {
            background-color: #f06292;
            color: black;
            font-weight: bold;
        }

        .filter-container {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            gap: 15px;
            padding: 15px;
            background-color: #f8bbd0;
            border-radius: 8px;
            margin-bottom: 20px;
            margin-top: 20px;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            min-width: 160px;
            flex-grow: 1;
        }

        .filter-item label {
            font-weight: bold;
            font-size: 0.8rem;
            margin-bottom: 4px;
            color: #333;
        }

        .filter-item select {
            width: 100%;
            padding: 6px;
            border: 1px solid #aaa;
            border-radius: 4px;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.85rem;
            height: 35px;
        }

        .action-button-container {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 6px 15px;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        #btnResetFilter {
            background-color: #d9534f;
        }

        #btnDownload {
            background-color: #5cb85c;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div class="header">
            <div class="header-text">
                <h1><span style="color:navy;">CDD</span> <span style="color:deeppink;">Women</span> <span
                        style="color:red;">Fund</span></h1>
                <h2><span style="color:black;">‡∏£‡∏≤‡∏¢‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</span> <span style="color:red;" id="province-title"></span>
                </h2>
            </div>

            <div class="logo-container">
                <img src="https://i.postimg.cc/507bjy9Z/cdd.png" width="60" height="100" />
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZtkPBp_xmIFgEEmX2cyScE1QzabzZbtNdbQ&s"
                    width="70" height="100" />
            </div>
        </div>

        <div style="text-align:right;font-weight:bold;color:navy;margin-top:1rem;font-size:1.2rem;">
            <span id="update-date">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -</span>
        </div>

        <!-- Summary Cards -->
        <div class="cards">

            <div class="card pink">
                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                <div class="value" id="num-projects">-</div>
            </div>

            <div class="card light-pink">
                ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                <div class="value" id="approved-money">-</div>
            </div>

            <div class="card orange">
                ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì 1 ‡∏ï.‡∏Ñ. 2568
                <div class="value" id="debt-start">-</div>
                ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                <div class="value" id="debt-now">-</div>
            </div>

            <div class="card deep-pink">
                ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                <div class="value" id="overdue">-</div>
                ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞
                <div class="value" id="percent-overdue">-</div>
            </div>

            <div class="card deep-pink">
                ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢
                <div class="value" id="legal">-</div>
            </div>

            <!-- ‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏Å‡∏ï‡∏¥ -->
            <div class="card light-pink">
                ‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)
                <div class="value" id="normal-count">-</div>
                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞)
                <div class="value" id="normal-amount">-</div>
            </div>

            <!-- ‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á (‡∏Ñ) -->
            <div class="card light-pink">
                ‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á (‡∏Ñ) ‚Äì ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                <div class="value" id="restructure-count">-</div>
                ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î ‚Äú‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢ (‡∏Ñ)‚Äù
                <div class="value" id="restructure-sum">-</div>
            </div>

            <!-- ‡∏´‡∏ô‡∏µ‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡πÅ‡∏û‡πà‡∏á (‡∏á1‚Äì‡∏á2) -->
            <div class="card orange">
                ‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡πÅ‡∏û‡πà‡∏á ‚Äì ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡∏á1 + ‡∏á2)
                <div class="value" id="civil-count">-</div>

                ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏á1)
                <div class="value" id="civil-prosecutor">-</div>

                ‡∏®‡∏≤‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ü‡πâ‡∏≠‡∏á (‡∏á2)
                <div class="value" id="civil-court">-</div>

                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏á1 + ‡∏á2)
                <div class="value" id="civil-sum">-</div>
            </div>
            <!-- ‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡πâ‡∏ß (‡∏á3‚Äì‡∏á5) -->
            <div class="card deep-pink">
                ‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚Äì ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡∏á3 + ‡∏á4 + ‡∏á5)
                <div class="value" id="judged-count">-</div>

                ‡∏®‡∏≤‡∏•‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ (‡∏á3)
                <div class="value" id="judged-3">-</div>

                ‡∏®‡∏≤‡∏•‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏° (‡∏á4)
                <div class="value" id="judged-4">-</div>

                ‡∏õ.‡∏ß‡∏¥ ‡πÅ‡∏û‡πà‡∏á ‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 20 ‡∏ï‡∏£‡∏µ (‡∏á5)
                <div class="value" id="judged-5">-</div>

                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏á3 + ‡∏á4 + ‡∏á5)
                <div class="value" id="judged-sum">-</div>
            </div>

            <!-- ‡∏´‡∏ô‡∏µ‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡∏≠‡∏≤‡∏ç‡∏≤ (‡∏á6) -->
            <div class="card orange">
                ‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡∏≠‡∏≤‡∏ç‡∏≤ ‚Äì ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                <div class="value" id="criminal-count">-</div>

                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏á6)
                <div class="value" id="criminal-sum">-</div>
            </div>
        </div>




        <h3>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <div id="filter-section" class="filter-container"></div>

        <div class="filter-container">
            <div class="filter-item">
                <label for="downloadType">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</label>
                <select id="downloadType">
                    <option value="excel">Excel</option>
                </select>
            </div>
            <div class="action-button-container">
                <button id="btnDownload">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
                <button id="btnResetFilter">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
            </div>
        </div>

        <h3>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</h3>
        <table id="detailsTable" class="display" style="width:100%">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwwxjRdiPSd7SOuZAOO5OmWi5NHCBMOf3d1923ik9QBY7iiZ0gJl6ppcQQUHGrxuLRTAg/exec";  // ‚≠ê ‡πÉ‡∏™‡πà URL Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚≠ê

        let originalData = [];
        let summary = {};

        async function loadData() {
            try {
                const res = await fetch("URL_API");
                const json = await res.json();

                // ‡πÄ‡∏Å‡πá‡∏ö summary ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                summary = json.summary;

                // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡πÅ‡∏ñ‡∏ß‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
                originalData = (json.data || []).filter(r => r["‡∏•‡∏≥‡∏î‡∏±‡∏ö"] !== "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î");

                // ‡πÇ‡∏´‡∏•‡∏î dropdown ‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                loadDistrictOptions(originalData);
                loadSubDistrictOptions(originalData);

                // üî•üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î API üî•üî•
                renderTable(originalData);
                updateSummaryFromFiltered(originalData);  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì summary ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
                updateSummaryCards(summary);              // ‡∏´‡∏£‡∏∑‡∏≠ summary ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î

            } catch (err) {
                console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", err);
            }
        }
        let allData = [], dataTable, originalSummary = null;

        const formatNumber = v => isNaN(parseFloat(v)) ? "-" : parseFloat(v).toLocaleString("th-TH", { minimumFractionDigits: 2 });
        const formatPercent = v => isNaN(parseFloat(v)) ? "-" : `${parseFloat(v).toFixed(2)}%`;

        $(document).ready(async function () {
            const province = new URLSearchParams(window.location.search).get("province");
            $("#province-title").text(province || "-");

            $("#btnResetFilter").on("click", () => {
                $("#filter-section select").val("").trigger("change");
                renderTable(allData);
                updateSummaryCards(originalSummary);
            });

            $("#btnDownload").on("click", downloadData);

            await fetchData(province);

            // ‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å fetchData ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚≠ê
            renderTable(allData);
            updateSummaryFromFiltered(allData);  // ‚Üê ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!
        });




        async function fetchData(province) {
            try {
                const res = await fetch(`${API_URL}?province=${encodeURIComponent(province)}`);
                const json = await res.json();

                if (json.error) throw new Error(json.error);

                allData = json.data || [];
                originalSummary = json.summary;

                updateSummaryCards(json.summary);
                renderTable(allData);
                setupFilters(allData);

            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            }
        }

        function renderTable(data) {
            const headers = Object.keys(data[0] || {});
            $("#detailsTable thead").html(`<tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>`);
            const tbody = $("#detailsTable tbody").empty();

            data.forEach(row => {
                tbody.append(`<tr>${headers.map(h => `<td>${row[h] ?? "-"}</td>`).join("")}</tr>`);
            });

            if ($.fn.DataTable.isDataTable("#detailsTable")) {
                $("#detailsTable").DataTable().destroy();
            }

            dataTable = $("#detailsTable").DataTable({ scrollX: true, pageLength: 10 });
        }

        function setupFilters(data) {
            const keys = ["‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï", "‡∏ï‡∏≥‡∏ö‡∏•", "‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"];
            const container = $("#filter-section").empty();

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á select ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ key
            keys.forEach(k => {
                container.append(`
      <div class="filter-item">
        <label>${k}</label>
        <select data-key="${k}">
          <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
        </select>
      </div>
    `);
            });

            const selects = $("#filter-section select");

            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ select
            function updateSelectOptions(filteredData) {
                selects.each(function () {
                    const key = $(this).data("key");
                    const currentVal = $(this).val();

                    let options = [...new Set(filteredData.map(r => r[key]).filter(Boolean))].sort();
                    const html = `<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>` + options.map(v => `<option value="${v}">${v}</option>`).join("");
                    $(this).html(html);

                    if (options.includes(currentVal)) $(this).val(currentVal);
                });
            }

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° select ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            function filterData() {
                let filtered = [...allData];

                selects.each(function () {
                    const key = $(this).data("key");
                    const val = $(this).val();
                    if (val) {
                        filtered = filtered.filter(r => r[key] == val);
                    }
                });

                renderTable(filtered); // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
                updateSummaryFromFiltered(filtered); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å select ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á (dependent)
                updateSelectOptions(filtered);
            }

            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
            updateSelectOptions(data);

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ select ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Üí ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            selects.on("change", filterData);
        }

        function updateSummaryCards(summary) {
            if (!summary) return;

            const num = v => {
                const n = parseFloat(String(v).replace(/,/g, ""));
                return isNaN(n) ? 0 : n;
            };
            const fmt = v => num(v).toLocaleString("th-TH", { minimumFractionDigits: 2 });

            const set = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            // ==== ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏à‡∏≤‡∏Å API ====
            const totalProjects = summary.totalProjects ?? summary.numProjects ?? summary.total_projects ?? 0;
            const approvedMoney = summary.approvedMoney ?? summary.approved_money ?? summary.approved ?? 0;
            const debtStart = summary.debtStart ?? summary.debt_start ?? 0;
            const debtNow = summary.debtNow ?? summary.debt_now ?? 0;
            const overdue = summary.overdue ?? summary.overdueAmount ?? summary.overdue_amount ?? 0;
            const percentOverdue = summary.percentOverdue ?? summary.percent_overdue ?? 0;
            const legal = summary.legal ?? summary.legalAmount ?? summary.legal_amount ?? 0;

            // ==== ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DOM ====
            set("num-projects", num(totalProjects).toLocaleString("th-TH"));
            set("approved-money", fmt(approvedMoney));
            set("debt-start", fmt(debtStart));
            set("debt-now", fmt(debtNow));
            set("overdue", fmt(overdue));
            set("percent-overdue", `${num(percentOverdue).toFixed(2)}%`);
            set("legal", fmt(legal));
        }


        function calculateNormalDebt(data) {
            let filtered = data.filter(r =>
                parseFloat(r["‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å)"]) > 0 &&
                parseFloat(r["‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ç)"]) > 0 &&
                parseFloat(r["‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏î‡∏µ‡πÑ‡∏î‡πâ (‡∏Ñ)"]) == 0 &&
                parseFloat(r["‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ (‡∏á)"]) == 0 &&
                parseFloat(r["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (B)"]) == 0
            );

            let count = filtered.length;
            let amount = filtered.reduce(
                (sum, r) => sum + (parseFloat(r["‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ç)"]) || 0),
                0
            );

            return { count, amount };
        }


        function updateSummaryFromFiltered(data) {

            if (!Array.isArray(data)) return;

            data = data.filter(r => r["‡∏•‡∏≥‡∏î‡∏±‡∏ö"] !== "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î");

            let normalCount = 0, normalAmount = 0;
            let restructureCount = 0, restructureSum = 0;
            let civilCount = 0, civilSum = 0;
            let ng1c = 0, ng1s = 0, ng2c = 0, ng2s = 0;

            let judgedCount = 0, judgedSum = 0;
            let jc3 = 0, js3 = 0, jc4 = 0, js4 = 0, jc5 = 0, js5 = 0;

            let criminalCount = 0, criminalSum = 0;

            const num = v => parseFloat(v) || 0;

            data.forEach(row => {

                const g = num(row["‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å)"]);
                const kh = num(row["‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ç)"]);
                const k = num(row["‡∏Å‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πà‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏î‡∏µ‡πÑ‡∏î‡πâ (‡∏Ñ)"]);
                const ng = num(row["‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ (‡∏á)"]);
                const b = num(row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (B)"]);

                const n1 = num(row["‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á(‡∏á1)"]);
                const n2 = num(row["‡∏®‡∏≤‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ü‡πâ‡∏≠‡∏á(‡∏á2)"]);
                const n3 = num(row["‡∏®‡∏≤‡∏•‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ(‡∏á3)"]);
                const n4 = num(row["‡∏®‡∏≤‡∏•‡∏°‡∏µ‡∏Ñ‡∏≥‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏°(‡∏á4)"]);
                const n5 = num(row["‡∏õ.‡∏ß‡∏¥ ‡πÅ‡∏û‡πà‡∏á ‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 20 ‡∏ï‡∏£‡∏µ(‡∏á5)"]);
                const n6 = num(row["‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡∏≠‡∏≤‡∏ç‡∏≤(‡∏á6)"]);

                // ---- ‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏Å‡∏ï‡∏¥ ----
                if (g > 0 && kh > 0 && k === 0 && ng === 0) {
                    normalCount++;
                    normalAmount += kh;
                }

                // ---- ‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á (‡∏Ñ) ----
                if (k > 0) {
                    restructureCount++;
                    restructureSum += k;
                }

                // ---- ‡∏á1 - ‡∏á2 ----
                if (n1 > 0 || n2 > 0) {
                    civilCount++;
                    civilSum += n1 + n2;

                    if (n1 > 0) { ng1c++; ng1s += n1; }
                    if (n2 > 0) { ng2c++; ng2s += n2; }
                }

                // ---- ‡∏á3 - ‡∏á5 ----
                if (n3 > 0 || n4 > 0 || n5 > 0) {
                    judgedCount++;
                    judgedSum += n3 + n4 + n5;

                    if (n3 > 0) { jc3++; js3 += n3; }
                    if (n4 > 0) { jc4++; js4 += n4; }
                    if (n5 > 0) { jc5++; js5 += n5; }
                }

                // ---- ‡∏á6 ----
                if (n6 > 0) {
                    criminalCount++;
                    criminalSum += n6;
                }
            });

            // ----- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DOM -----
            const set = (id, txt) => {
                const el = document.getElementById(id);
                if (el) el.textContent = txt;
            };

            set("normal-count", normalCount.toLocaleString());
            set("normal-amount", normalAmount.toLocaleString());

            set("restructure-count", restructureCount.toLocaleString());
            set("restructure-sum", restructureSum.toLocaleString());

            set("civil-count", civilCount.toLocaleString());
            set("civil-prosecutor", `${ng1c} / ${ng1s.toLocaleString()}`);
            set("civil-court", `${ng2c} / ${ng2s.toLocaleString()}`);
            set("civil-sum", civilSum.toLocaleString());

            set("judged-count", judgedCount.toLocaleString());
            set("judged-3", `${jc3} / ${js3.toLocaleString()}`);
            set("judged-4", `${jc4} / ${js4.toLocaleString()}`);
            set("judged-5", `${jc5} / ${js5.toLocaleString()}`);
            set("judged-sum", judgedSum.toLocaleString());

            set("criminal-count", criminalCount.toLocaleString());
            set("criminal-sum", criminalSum.toLocaleString());
        }




        function downloadData() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(allData);
            XLSX.utils.book_append_sheet(wb, ws, "Province");
            XLSX.writeFile(wb, `${$("#province-title").text()}_KPI69.xlsx`);
        }
    </script>

</body>

</html>