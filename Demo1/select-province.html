<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</title>
</head>

<body>

<h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</h3>

<select id="prov"></select>
<button onclick="go()">‡∏ï‡∏Å‡∏•‡∏á</button>

<script>
    // üîπ ‡πÉ‡∏™‡πà API ‡∏à‡∏£‡∏¥‡∏á
    const API = "https://script.google.com/macros/s/AKfycbzGHNMtBSIhJfjk6WupY6IqP9V4QSGM4eTfOMKIOkqloOL0Pvn4ZF41FhWZVvpPHExs/exec";

    const provinces = JSON.parse(localStorage.getItem("provinces"));

    if (!provinces || provinces.length === 0) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
        location.href = "login.html";
    }

    provinces.forEach(p => {
        prov.innerHTML += `<option value="${p}">${p}</option>`;
    });

    function go() {
        const province = prov.value;

        fetch(`${API}?getTokenOf=${encodeURIComponent(province)}`)
            .then(r => r.json())
            .then(res => {

                console.log("TOKEN RESPONSE:", res); // üîç debug

                if (!res.token) {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡∏Ç‡∏≠‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏µ‡πâ");
                    return;
                }

                // ‚úÖ token ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
                location.href =
                  `province.html?province=${encodeURIComponent(province)}&token=${encodeURIComponent(res.token)}`;
            })
            .catch(err => {
                console.error(err);
                alert("‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            });
    }
</script>

</body>
</html>
