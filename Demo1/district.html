<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>สรุปรายอำเภอ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --pink: #e91e63;
            --deep-pink: #c2185b;
            --navy: #1a237e;
            --bg1: #fce4ec;
            --bg2: #f5f5f5;
            --border: #d1c4e9;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            margin: 0;
            background: linear-gradient(to bottom right, var(--bg1), var(--bg2));
        }

        /* ===== Nav ===== */
        .navbar {
            background: linear-gradient(90deg, #1a237e, #283593);
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            font-weight: 700;
        }

        .navbar button {
            background: rgba(255, 255, 255, .12);
            border: 1px solid rgba(255, 255, 255, .4);
            color: #fff;
            padding: 6px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Sarabun';
            font-size: .85rem;
            transition: .2s;
        }

        .navbar button:hover {
            background: rgba(255, 255, 255, .25);
        }

        /* ===== Main ===== */
        .main {
            max-width: 1300px;
            margin: auto;
            padding: 26px 20px;
        }

        h2 {
            color: var(--deep-pink);
            margin: 0 0 14px;
        }

        .btn {
            background: linear-gradient(135deg, var(--pink), var(--deep-pink));
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 8px 14px;
            cursor: pointer;
            font-family: 'Sarabun';
            font-size: .85rem;
            font-weight: 700;
            margin-bottom: 14px;
            transition: transform .15s ease, box-shadow .15s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(233, 30, 99, .35);
        }

        /* ===== Table ===== */
        .table-wrapper {
            overflow-x: auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 18px rgba(0, 0, 0, .08);
        }

        table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            border: 2px solid var(--border);
        }

        th,
        td {
            border: 1.5px solid var(--border);
            padding: 8px 10px;
            text-align: center;
            font-size: .9rem;
            white-space: nowrap;
        }

        th {
            background: #fce4ec;
            color: #880e4f;
            font-weight: 700;
        }

        tbody tr:nth-child(even) td {
            background: #fafafa;
        }

        tbody tr:hover td {
            background: #fde7f3;
        }

        tfoot td {
            font-weight: 700;
            background: #f8bbd0;
            color: #4a0033;
        }
    </style>
</head>

<body>

    <div class="navbar">
        <div>CDD Women Fund</div>
        <button onclick="logout()">ออกจากระบบ</button>
    </div>

    <div class="main">
        <h2 id="title">กำลังโหลดข้อมูล…</h2>

        <button class="btn" onclick="goAllProjects()">
            ดูโครงการทั้งหมด
        </button>

        <div class="table-wrapper">
            <table id="tbl">
                <thead></thead>
                <tbody></tbody>
                <tfoot></tfoot>
            </table>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        const params = new URLSearchParams(location.search);
        const province = params.get("province");
        const token = params.get("token");

        if (!province || !token) {
            alert("กรุณาเข้าสู่ระบบใหม่");
            location.href = "login.html";
        }

        title.innerText = `สรุปรายอำเภอ จังหวัด${province}`;

        const START = new Date("2025-10-01");
        const MAR31 = new Date("2026-03-31");
        const SEP30 = new Date("2026-09-30");

        fetch(`${API}?province=${encodeURIComponent(province)}&token=${encodeURIComponent(token)}`)
            .then(r => r.json())
            .then(res => {
                const summary = summarizeByDistrict(res.data);
                renderTable(summary);
            });

        function summarizeByDistrict(data) {
            const map = {};

            data.forEach(r => {
                if (r["สถานะการมีข้อมูลใน ค-ง"] !== "ไม่มีข้อมูล") return;

                const district = r["อำเภอ"];
                const due = new Date(r["กำหนดชำระ"]);
                if (isNaN(due) || due < START) return;

                if (!map[district]) {
                    map[district] = { expect_mar: 0, expect_sep: 0, paid: 0 };
                }

                const expect = Number(r["เงินต้นที่คาดว่าจะได้"] || 0);
                const paid = Number(r["เงินต้นรับคืน"] || 0);

                if (due <= MAR31) {
                    map[district].expect_mar += expect;
                    map[district].paid += paid;
                }
                if (due <= SEP30) {
                    map[district].expect_sep += expect;
                }
            });

            return Object.entries(map).map(([d, v]) => ({
                อำเภอ: d,
                "เงินต้นเป้าหมายการรับชำระคืน ณ 31 มี.ค. 69": v.expect_mar,
                "เงินต้นที่ได้รับชำระคืนแล้ว": v.paid,
                "ร้อยละ (31 มี.ค. 69)": v.expect_mar ? v.paid * 100 / v.expect_mar : 0,
                "เงินต้นเป้าหมายการรับชำระคืน ณ 30 ก.ย. 69": v.expect_sep,
                "ร้อยละ (30 ก.ย. 69)": v.expect_sep ? v.paid * 100 / v.expect_sep : 0
            }));
        }

        function renderTable(data) {
            const thead = tbl.querySelector("thead");
            const tbody = tbl.querySelector("tbody");
            const tfoot = tbl.querySelector("tfoot");

            const headers = [...Object.keys(data[0]), "ดูโครงการ"];

            thead.innerHTML =
                `<tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>`;

            let sum_expect_mar = 0;
            let sum_expect_sep = 0;
            let sum_paid = 0;

            tbody.innerHTML = "";
            data.forEach(r => {
                const tr = document.createElement("tr");

                headers.forEach(h => {
                    let td = document.createElement("td");

                    if (h === "ดูโครงการ") {
                        td.innerHTML =
                            `<button class="btn" onclick="goProject('${r.อำเภอ}')">ดูโครงการ</button>`;
                    } else {
                        let v = r[h];
                        if (typeof v === "number") {
                            v = h.includes("ร้อยละ")
                                ? v.toFixed(2)
                                : v.toLocaleString();
                        }
                        td.innerText = v;
                    }
                    tr.appendChild(td);
                });

                sum_expect_mar += r["เงินต้นเป้าหมายการรับชำระคืน ณ 31 มี.ค. 69"];
                sum_expect_sep += r["เงินต้นเป้าหมายการรับชำระคืน ณ 30 ก.ย. 69"];
                sum_paid += r["เงินต้นที่ได้รับชำระคืนแล้ว"];

                tbody.appendChild(tr);
            });

            const percent_mar = sum_expect_mar ? sum_paid * 100 / sum_expect_mar : 0;
            const percent_sep = sum_expect_sep ? sum_paid * 100 / sum_expect_sep : 0;

            tfoot.innerHTML = `
            <tr>
                <td><strong>รวมทั้งจังหวัด</strong></td>
                <td>${sum_expect_mar.toLocaleString()}</td>
                <td>${sum_paid.toLocaleString()}</td>
                <td>${percent_mar.toFixed(2)}</td>
                <td>${sum_expect_sep.toLocaleString()}</td>
                <td>${percent_sep.toFixed(2)}</td>
                <td>-</td>
            </tr>
        `;
        }

        function goProject(district) {
            location.href =
                `project-info.html?province=${encodeURIComponent(province)}&district=${encodeURIComponent(district)}&token=${encodeURIComponent(token)}`;
        }

        function logout() {
            location.href = "login.html";
        }

        function goAllProjects() {
            location.href =
                `project-info.html?province=${encodeURIComponent(province)}&token=${encodeURIComponent(token)}`;
        }

    </script>

</body>

</html>