<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --pink: #e91e63;
            --bg: #f5f5f5;
            --border: #d1c4e9;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: var(--bg);
            margin: 0;
        }

        .main {
            max-width: 1200px;
            margin: auto;
            padding: 20px;
        }

        h2 {
            color: var(--pink);
            margin-bottom: 12px;
        }

        .table-wrapper {
            overflow-x: auto;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, .06);
        }

        table {
            width: 100%;
            min-width: 1100px;
            border-collapse: collapse;
            border: 2px solid var(--border);
        }

        th,
        td {
            border: 1.5px solid var(--border);
            padding: 8px;
            text-align: center;
            font-size: .9rem;
            white-space: nowrap;
        }

        th {
            background: #fce4ec;
            color: #880e4f;
            font-weight: 700;
        }

        tbody tr:hover {
            background: #f3e5f5;
        }

        tfoot td {
            font-weight: 700;
            background: #f8bbd0;
        }
    </style>
</head>

<body>

<div class="main">
    <h2 id="title">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</h2>

    <div class="table-wrapper">
        <table id="tbl">
            <thead></thead>
            <tbody></tbody>
            <tfoot></tfoot>
        </table>
    </div>
</div>

<script src="js/config.js"></script>
<script>
    const params = new URLSearchParams(location.search);
    const province = params.get("province");
    const token = params.get("token");

    title.innerText = `‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î${province}`;

    const START = new Date("2025-10-01");
    const MAR31 = new Date("2026-03-31");
    const SEP30 = new Date("2026-09-30");

    fetch(`${API}?province=${province}&token=${token}`)
        .then(r => r.json())
        .then(res => {
            const summary = summarizeByDistrict(res.data);
            renderTable(summary);
        });

    function summarizeByDistrict(data) {
        const map = {};

        data.forEach(r => {

            // ‚úÖ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
            if (r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô ‡∏Ñ-‡∏á"] !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•") return;

            const district = r["‡∏≠‡∏≥‡πÄ‡∏†‡∏≠"];
            const due = new Date(r["‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞"]);
            if (isNaN(due) || due < START) return;

            if (!map[district]) {
                map[district] = {
                    expect_mar: 0,
                    expect_sep: 0,
                    paid: 0
                };
            }

            const expect = Number(r["‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ"] || 0);
            const paid = Number(r["‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô"] || 0);

            // üîπ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á 31 ‡∏°‡∏µ.‡∏Ñ. 69 + ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô
            if (due <= MAR31) {
                map[district].expect_mar += expect;
                map[district].paid += paid;
            }

            // üîπ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á 30 ‡∏Å.‡∏¢. 69
            if (due <= SEP30) {
                map[district].expect_sep += expect;
            }
        });

        return Object.entries(map).map(([d, v]) => ({
            ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠: d,
            "‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏∑‡∏ô ‡∏ì 31 ‡∏°‡∏µ.‡∏Ñ. 69": v.expect_mar,
            "‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß": v.paid,
            "‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ (31 ‡∏°‡∏µ.‡∏Ñ. 69)": v.expect_mar ? v.paid * 100 / v.expect_mar : 0,
            "‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏∑‡∏ô ‡∏ì 30 ‡∏Å.‡∏¢. 69": v.expect_sep,
            "‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ (30 ‡∏Å.‡∏¢. 69)": v.expect_sep ? v.paid * 100 / v.expect_sep : 0
        }));
    }

    function renderTable(data) {
        const thead = tbl.querySelector("thead");
        const tbody = tbl.querySelector("tbody");
        const tfoot = tbl.querySelector("tfoot");

        const headers = Object.keys(data[0]);

        /* ===== THEAD ===== */
        thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>`;

        /* ===== TBODY ===== */
        tbody.innerHTML = "";
        data.forEach(r => {
            const tr = document.createElement("tr");
            headers.forEach(h => {
                let v = r[h];
                if (typeof v === "number") {
                    v = h.includes("‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞")
                        ? v.toFixed(2)
                        : v.toLocaleString();
                }
                tr.innerHTML += `<td>${v}</td>`;
            });
            tbody.appendChild(tr);
        });

        /* ===== TFOOT ===== */
        let sum_expect_mar = 0;
        let sum_expect_sep = 0;
        let sum_paid = 0;

        data.forEach(r => {
            sum_expect_mar += r["‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏∑‡∏ô ‡∏ì 31 ‡∏°‡∏µ.‡∏Ñ. 69"];
            sum_expect_sep += r["‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏∑‡∏ô ‡∏ì 30 ‡∏Å.‡∏¢. 69"];
            sum_paid += r["‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß"];
        });

        const percent_mar = sum_expect_mar ? sum_paid * 100 / sum_expect_mar : 0;
        const percent_sep = sum_expect_sep ? sum_paid * 100 / sum_expect_sep : 0;

        tfoot.innerHTML = `
            <tr>
                <td><strong>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</strong></td>
                <td>${sum_expect_mar.toLocaleString()}</td>
                <td>${sum_paid.toLocaleString()}</td>
                <td>${percent_mar.toFixed(2)}</td>
                <td>${sum_expect_sep.toLocaleString()}</td>
                <td>${percent_sep.toFixed(2)}</td>
            </tr>
        `;
    }
</script>

</body>
</html>
