<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏™‡∏ï‡∏£‡∏µ</title>

<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Sarabun',sans-serif;
  margin:0;
  padding:20px;
  background:linear-gradient(to bottom right,#ffe6f0,#ffd1e6);
  display:flex;
  justify-content:center;
  min-height:100vh;
}
.container{
  width:100%;
  max-width:1400px;
  background:rgba(255,255,255,.95);
  border-radius:25px;
  padding:30px;
  box-shadow:0 8px 25px rgba(233,30,99,.25);
  position:relative;
}
.logos-top{
  position:absolute;
  top:20px;
  right:20px;
  display:flex;
  gap:10px;
}
.logos-top img{height:55px}

.header-block{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  flex-wrap:wrap;
  margin-bottom:10px;
}
#reportInfo{
  flex:1;
  text-align:center;
  color:#880e4f;
  font-weight:bold;
  margin-top:40px;
  line-height:1.6em;
}
#reportDate{
  flex-basis:100%;
  text-align:right;
  color:#880e4f;
  font-weight:bold;
  font-size:.95rem;
  margin-top:5px;
}

/* toolbar */
.toolbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.left-tools button{
  background:#f8bbd0;
  border:none;
  border-radius:8px;
  padding:6px 12px;
  color:#880e4f;
  font-weight:bold;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:6px;
}
.left-tools img{height:18px}

.filter-bar{
  display:flex;
  align-items:center;
  gap:8px;
}
.filter-bar select,
.filter-bar input{
  padding:6px 10px;
  border-radius:8px;
  border:1px solid #f48fb1;
  font-family:'Sarabun';
  font-size:.9rem;
}
#downloadBtn{
  background:#f8bbd0;
  border:none;
  border-radius:8px;
  padding:6px 12px;
  color:#880e4f;
  font-weight:bold;
  cursor:pointer;
}

/* table */
.table-wrapper{
  overflow:auto;
  max-height:80vh;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(233,30,99,.1);
  background:white;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:.9rem;
}
th,td{
  border:1px solid #c97a9b;
  padding:6px 8px;
  text-align:center;
  white-space:nowrap;
}
thead th{
  background:#f8bbd0;
  color:#880e4f;
  font-weight:700;
}
thead tr:nth-child(1) th{position:sticky;top:0}
thead tr:nth-child(2) th{position:sticky;top:32px}
thead tr:last-child th{border-bottom:2.5px solid #880e4f}

tr:nth-child(even) td{background:rgba(255,182,193,.12)}
tr:nth-child(odd) td{background:rgba(255,192,203,.05)}

.empty-row td{
  padding:15px;
  font-style:italic;
  color:#c62828;
}
</style>
</head>

<body>
<div class="container">

  <div class="logos-top">
    <img src="https://i.postimg.cc/507bjy9Z/cdd.png">
    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZtkPBp_xmIFgEEmX2cyScE1QzabzZbtNdbQ&s">
  </div>

  <div class="header-block">
    <div id="reportInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...</div>
    <div id="reportDate"></div>
  </div>

  <div class="toolbar">
    <div class="left-tools">
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ)
      <button onclick="window.top.location.href='Menu.html'">
        <img src="https://cdn-icons-png.flaticon.com/512/25/25694.png"> ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
      </button>
      -->
    </div>

    <div class="filter-bar">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
      <select id="sheetSelect" onchange="onSheetChange()">
        <option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
      </select>

      üîç <input type="text" id="filterInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...">

      <button id="downloadBtn" onclick="downloadExcel()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel</button>
    </div>
  </div>

  <div class="table-wrapper">
    <table id="dataTable">
      <thead id="tableHead"></thead>
      <tbody id="tableBody">
        <tr class="empty-row"><td colspan="30">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwlH8Smpn_snzR7K8RTURfMxNpg7l-ucuRGwDeMRKl-zvRElclqX6ywt_8ZqkIbXxGO/exec';

let currentSheet='';
const START_HEADER_ROW=3;
const END_HEADER_ROW=4;
const START_BODY_ROW=5;

window.onload=()=>loadSheetList();

async function loadSheetList(){
  const sel=document.getElementById('sheetSelect');
  try{
    const res=await fetch(`${API_URL}?action=listSheets`);
    const json=await res.json();
    sel.innerHTML='';
    json.sheets.forEach((s,i)=>{
      const o=document.createElement('option');
      o.value=s;o.textContent=s;
      sel.appendChild(o);
      if(i===0)currentSheet=s;
    });
    requestAnimationFrame(()=>loadSheet(currentSheet));
  }catch(e){
    sel.innerHTML='<option>‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>';
  }
}

function onSheetChange(){
  currentSheet=document.getElementById('sheetSelect').value;
  loadSheet(currentSheet);
}

async function loadSheet(sheet){
  const info=document.getElementById('reportInfo');
  const date=document.getElementById('reportDate');
  const thead=document.getElementById('tableHead');
  const tbody=document.getElementById('tableBody');

  info.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...';
  tbody.innerHTML='<tr class="empty-row"><td colspan="30">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

  const res=await fetch(`${API_URL}?sheetName=${encodeURIComponent(sheet)}`);
  const json=await res.json();
  const {data,merged}=json;

  info.innerHTML=data.slice(0,2).map(r=>r.join(' ')).join('<br>');
  date.textContent=data[2]?.join(' ')||'';

  const headerRows=data.slice(START_HEADER_ROW,END_HEADER_ROW+1);
  const headerMerged=merged
    .filter(m=>m.row>=START_HEADER_ROW&&m.row<=END_HEADER_ROW)
    .map(m=>({row:m.row-START_HEADER_ROW,col:m.col,width:m.width,height:m.height}));

  thead.innerHTML=applyMergedCells(headerRows,headerMerged,true);
  renderBody(data.slice(START_BODY_ROW));
}

function applyMergedCells(rows,merged,isHeader){
  let html='',hidden=[];
  const tag=isHeader?'th':'td';
  rows.forEach((r,i)=>{
    hidden[i]=[];
    html+='<tr>';
    r.forEach((c,j)=>{
      if(hidden[i][j])return;
      const m=merged.find(x=>x.row===i&&x.col===j);
      let attr='';
      if(m){
        attr=` rowspan="${m.height}" colspan="${m.width}"`;
        for(let a=0;a<m.height;a++)
          for(let b=0;b<m.width;b++)
            if(a||b)hidden[i+a][j+b]=true;
      }
      html+=`<${tag}${attr}>${c??''}</${tag}>`;
    });
    html+='</tr>';
  });
  return html;
}

function renderBody(rows){
  const tbody=document.getElementById('tableBody');
  let html='';
  rows.forEach(r=>{
    html+='<tr>';
    r.forEach(c=>{
      html+=`<td>${typeof c==='number'?c.toLocaleString('th-TH'):c??''}</td>`;
    });
    html+='</tr>';
  });
  tbody.innerHTML=html;
}

document.getElementById('filterInput').addEventListener('keyup',function(){
  const k=this.value.toLowerCase();
  document.querySelectorAll('#tableBody tr').forEach(r=>{
    r.style.display=r.innerText.toLowerCase().includes(k)?'':'none';
  });
});

function downloadExcel(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.table_to_sheet(document.getElementById('dataTable'));
  XLSX.utils.book_append_sheet(wb,ws,currentSheet||'Report');
  XLSX.writeFile(wb,`KPI_${currentSheet}.xlsx`);
}
</script>

</body>
</html>
