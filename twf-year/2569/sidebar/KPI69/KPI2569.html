<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>KPI 2569 ‚Äì CDD Women Fund</title>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      margin: 0;
      background: linear-gradient(to bottom right, #ffe6f0, #f3e5f5, #e1bee7);
      background-attachment: fixed;
      color: #000;
    }

    /* ===== iframe mode ===== */
    body.iframe-mode {
      background: transparent;
    }
    body.iframe-mode .header,
    body.iframe-mode .toolbar {
      display: none;
    }
    body.iframe-mode .dashboard-container {
      padding: 10px 0;
      background: transparent;
      min-height: auto;
    }

    .dashboard-container {
      padding: 40px;
      background-color: rgba(255, 255, 255, 0.95);
      min-height: 100vh;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .header-text h1 { margin: 0; font-size: 2.4rem; }
    .header-text h2 { margin: 0; font-size: 1.4rem; }

    .cards {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .card {
      flex: 1;
      min-width: 260px;
      padding: 18px;
      border-radius: 12px;
      color: white;
      font-weight: bold;
    }

    .card .value {
      font-size: 1.6rem;
      margin-top: 6px;
      color: black;
      font-weight: normal;
    }

    .pink { background:#e91e63; }
    .light-pink { background:#FB6F92; }
    .orange { background:#ff9800; }
    .pastel-pink { background:#FF3333; }
    .deep-pastel-pink { background:#f06292; }

    .main-visuals {
      display: flex;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .left, .center { flex: 1; min-width: 320px; }
    .center img { width: 360px; display: block; margin: auto; }

    canvas { max-width: 100%; }

    .province-table-wrapper {
      margin-top: 30px;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th {
      background: #f06292;
      color: black;
      padding: 8px;
      border: 1px solid #f8bbd0;
      text-align: center;
    }

    td {
      padding: 6px 8px;
      border: 1px solid #f8bbd0;
      text-align: right;
      white-space: nowrap;
    }

    td.align-left { text-align: left; }

    tr:nth-child(even) { background:#fce4ec; }

    .province-link {
      color: blue;
      text-decoration: underline;
      cursor: pointer;
    }

    #log {
      margin-top: 10px;
      font-weight: bold;
      color: navy;
      text-align: center;
    }
  </style>
</head>

<body>

<div class="dashboard-container">

  <!-- ===== Header (‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô iframe) ===== -->
  <div class="header">
    <div class="header-text">
      <h1>CDD Women Fund</h1>
      <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ ‡∏õ‡∏µ‡∏á‡∏ö 2569</h2>
    </div>
  </div>

  <div id="log">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

  <!-- ===== Cards ===== -->
  <div class="cards">
    <div class="card pink">
      ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
      <div class="value" id="num-projects">-</div>
    </div>

    <div class="card light-pink">
      ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
      <div class="value" id="debt-now">-</div>
    </div>

    <div class="card orange">
      ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î
      <div class="value" id="overdue">-</div>
    </div>

    <div class="card deep-pastel-pink">
      ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î
      <div class="value" id="overdue-percent">-</div>
    </div>
  </div>

  <!-- ===== Charts + Table ===== -->
  <div class="main-visuals">
    <div class="left">
      <canvas id="donutChart"></canvas>
    </div>
    <div class="center">
      <img src="https://i.postimg.cc/hPqX5RFW/twdf.png">
    </div>
  </div>

  <div class="province-table-wrapper">
    <table id="provinceTable">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
const IS_IFRAME = window.self !== window.top;
if (IS_IFRAME) document.body.classList.add("iframe-mode");

/* ===== Login: ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÄ‡∏™‡∏°‡∏≠ ===== */
function goLogin(province) {
  sessionStorage.clear();
  window.top.location.href =
    `https://tnah097.github.io/cdwomenpod-dashboard/Login.html?province=${encodeURIComponent(province)}`;
}

/* ===== Resize iframe ===== */
function resizeIframe() {
  if (!IS_IFRAME) return;
  window.parent.postMessage(
    { type: "resize-iframe", height: document.body.scrollHeight },
    "*"
  );
}
window.addEventListener("resize", resizeIframe);

/* ===== Mock API ===== */
const API_URL = "https://script.google.com/macros/s/AKfycby-WMXu4yHrGqdETd37jqoYVpQK3lktS2lY-UMaze1Dz29jp1vUBNqeQz5DQmfBYddM/exec";

async function fetchData() {
  const res = await fetch(API_URL);
  const data = await res.json();

  document.getElementById("num-projects").textContent = data.overview?.B2 || "-";
  document.getElementById("debt-now").textContent = data.overview?.E2 || "-";
  document.getElementById("overdue").textContent = data.overview?.R2 || "-";
  document.getElementById("overdue-percent").textContent = data.overview?.S2 + "%" || "-";

  const provinces = data.provinces || [];
  const thead = document.querySelector("#provinceTable thead");
  const tbody = document.querySelector("#provinceTable tbody");

  thead.innerHTML = "<tr><th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th></tr>";
  tbody.innerHTML = "";

  provinces.forEach(p => {
    tbody.innerHTML += `
      <tr>
        <td class="align-left">
          <span class="province-link" onclick="goLogin('${p.province}')">${p.province}</span>
        </td>
        <td>${p.overdue || "-"}</td>
      </tr>
    `;
  });

  $('#provinceTable').DataTable({
    pageLength: 10,
    scrollX: true
  });

  document.getElementById("log").textContent = "‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  setTimeout(resizeIframe, 300);
}

fetchData();
</script>

</body>
</html>
