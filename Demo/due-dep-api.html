<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Due Debt</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Sarabun;background:#f4f6fb;padding:30px}
.card{background:#fff;padding:24px;border-radius:12px;max-width:1500px;margin:auto}

input,button{padding:8px;width:100%;margin-bottom:8px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
button{cursor:pointer}

.table-wrap{
  max-height:600px;
  overflow:auto;
  margin-top:16px;
}

table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;font-size:14px}
th{
  background:#eef;
  text-align:center;
  cursor:pointer;
  position:sticky;
  top:0;
  z-index:2;
}
td{text-align:right}
td.left{text-align:left}

tfoot td{
  font-weight:bold;
  background:#fafafa;
  position:sticky;
  bottom:0;
}

.error{color:red;margin-top:10px}

.pager{
  display:flex;
  gap:8px;
  align-items:center;
  margin-top:10px;
}
</style>
</head>

<body>
<div class="card">
<h2>ค้นหากำหนดชำระ</h2>

<!-- ค้นหา: เลขที่สัญญา + จังหวัด -->
<div class="grid">
  <input id="contract" placeholder="เลขที่สัญญา (ไม่บังคับ)">
  <input id="province" placeholder="จังหวัด (ไม่บังคับ)">
  <div></div>
  <div></div>
</div>

<div class="grid">
  <input type="date" id="start">
  <input type="date" id="end">
  <button onclick="search()">ค้นหา</button>
  <button onclick="exportExcel()">Export Excel</button>
</div>

<div class="pager" id="pager" style="display:none">
  แสดง
  <input type="number" id="from" value="1" min="1" style="width:80px">
  -
  <input type="number" id="to" value="100" style="width:80px">
  / <span id="total"></span>
  <button onclick="renderPage()">แสดง</button>
</div>

<div id="result"></div>
</div>

<script>
const API = ".../due-debt"; // ใส่ API จริง
let fullData = [];
let pageData = [];
let sortKey = null;
let sortAsc = true;

const cols = [
  {k:"province", t:"จังหวัด", left:true},
  {k:"district", t:"อำเภอ", left:true},
  {k:"sub_district", t:"ตำบล", left:true},
  {k:"ds_number_promise", t:"เลขที่สัญญา", left:true},
  {k:"ds_project", t:"ชื่อโครงการ", left:true},
  {k:"project_status", t:"สถานะโครงการ", left:true},
  {k:"due_date", t:"กำหนดชำระ"},
  {k:"expect_principle", t:"เงินต้นที่คาดว่าจะได้"},
  {k:"interest", t:"ดอกเบี้ย"},
  {k:"penalty", t:"เบี้ยปรับ"},
  {k:"re_principle", t:"เงินต้นรับคืน"},
  {k:"re_interest", t:"ดอกเบี้ยรับคืน"},
  {k:"re_penalty", t:"เบี้ยปรับรับคืน"},
];

function search(){
  if(!start.value || !end.value){
    result.innerHTML = `<div class="error">กรุณาเลือกช่วงวันที่</div>`;
    return;
  }

  const q = new URLSearchParams({
    start_date:start.value,
    end_date:end.value
  });

  if(contract.value) q.append("ds_number_promise", contract.value);
  if(province.value) q.append("province", province.value);

  fetch(API+"?"+q)
    .then(r=>r.json())
    .then(d=>{
      if(!d.found){
        result.innerHTML = `<div class="error">ไม่พบข้อมูล</div>`;
        return;
      }

      fullData = d.data;
      from.value = 1;
      to.value = Math.min(100, fullData.length);
      total.textContent = fullData.length;
      pager.style.display = "flex";
      renderPage();
    });
}

function renderPage(){
  const f = Math.max(1, Number(from.value));
  const t = Math.min(Number(to.value), fullData.length);

  from.value = f;
  to.value = t;

  pageData = fullData.slice(f-1, t);
  renderTable(pageData);
}

function renderTable(data){
  let html = `<div class="table-wrap"><table><thead><tr>`;
  cols.forEach(c=>{
    html += `<th onclick="sortTable('${c.k}')">${c.t}</th>`;
  });
  html += `</tr></thead><tbody>`;

  data.forEach(r=>{
    html += `<tr>`;
    cols.forEach(c=>{
      const v = r[c.k] ?? "";
      html += `<td class="${c.left?'left':''}">
        ${typeof v==="number" ? v.toLocaleString() : v}
      </td>`;
    });
    html += `</tr>`;
  });

  const s = summary(data);
  html += `</tbody><tfoot><tr>
    <td colspan="7">รวม</td>
    <td>${s.expect_principle.toLocaleString()}</td>
    <td>${s.interest.toLocaleString()}</td>
    <td>${s.penalty.toLocaleString()}</td>
    <td>${s.re_principle.toLocaleString()}</td>
    <td>${s.re_interest.toLocaleString()}</td>
    <td>${s.re_penalty.toLocaleString()}</td>
  </tr></tfoot></table></div>`;

  result.innerHTML = html;
}

function sortTable(key){
  sortAsc = sortKey === key ? !sortAsc : true;
  sortKey = key;

  fullData.sort((a,b)=>{
    if(a[key]==null) return 1;
    if(b[key]==null) return -1;
    return sortAsc ? (a[key]>b[key]?1:-1) : (a[key]<b[key]?1:-1);
  });

  renderPage();
}

function summary(data){
  const sum = k => data.reduce((s,r)=>s+(+r[k]||0),0);
  return {
    expect_principle:sum("expect_principle"),
    interest:sum("interest"),
    penalty:sum("penalty"),
    re_principle:sum("re_principle"),
    re_interest:sum("re_interest"),
    re_penalty:sum("re_penalty"),
  };
}

function exportExcel(){
  const ws = XLSX.utils.json_to_sheet(pageData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "DueDebt");
  XLSX.writeFile(wb, "due_debt.xlsx");
}
</script>
</body>
</html>