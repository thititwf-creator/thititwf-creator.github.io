<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Due Report Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
  margin: 0;
  font-family: "Sarabun", system-ui;
  background: linear-gradient(135deg, #667eea, #764ba2);
}

.container {
  max-width: 1400px;
  margin: 40px auto;
  padding: 20px;
}

.card {
  background: white;
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

h2 {
  margin-top: 0;
}

.filter-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 10px;
  margin-bottom: 15px;
}

input, select {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ddd;
}

button {
  padding: 10px 15px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
}

.btn-search {
  background: #4caf50;
  color: white;
}

.btn-export {
  background: #2196f3;
  color: white;
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  font-size: 14px;
}

th, td {
  padding: 8px;
  border-bottom: 1px solid #eee;
}

th {
  background: #2c3e50;
  color: white;
  cursor: pointer;
}

th.sort-asc::after { content: " ‚ñ≤"; }
th.sort-desc::after { content: " ‚ñº"; }

td.number {
  text-align: right;
}

tbody tr:hover {
  background: #f5f6fa;
}

tfoot td {
  font-weight: bold;
  background: #f1f2f6;
}
</style>
</head>

<body>

<div class="container">
<div class="card">

<h2>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞</h2>

<div class="filter-grid">
  <input type="date" id="start_date">
  <input type="date" id="end_date">
  <input type="text" id="province" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
  <input type="text" id="project_status" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£">
  <input type="text" id="contract_no" placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤">
  <input type="number" id="start_row" value="1">
  <input type="number" id="end_row" value="100">
</div>

<button class="btn-search" id="searchBtn" onclick="searchData()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
<button class="btn-export" id="exportBtn" onclick="exportExcel()">Export Excel</button>

<div id="info" style="margin-top:10px;"></div>

<table id="dataTable">
<thead></thead>
<tbody></tbody>
<tfoot></tfoot>
</table>

</div>
</div>

<script>

const API_URL = "https://api.twferp.click/due-report";

let currentData = [];
let sortState = { column: null, direction: "asc" };

function formatNumber(num) {
  return new Intl.NumberFormat('th-TH').format(num);
}

async function searchData() {

  const btn = searchBtn;
  btn.disabled = true;
  btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";

  const params = new URLSearchParams({
    start_date: start_date.value,
    end_date: end_date.value,
    province: province.value,
    project_status: project_status.value,
    contract_no: contract_no.value,
    start_row: start_row.value,
    end_row: end_row.value
  });

  const res = await fetch(`${API_URL}?${params}`);
  const json = await res.json();

  currentData = json.data || [];
  renderTable(currentData);

  info.innerText = `‡∏û‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${json.total || currentData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

  btn.disabled = false;
  btn.textContent = "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤";
}

function renderTable(data) {

  const thead = dataTable.querySelector("thead");
  const tbody = dataTable.querySelector("tbody");
  const tfoot = dataTable.querySelector("tfoot");

  thead.innerHTML = "";
  tbody.innerHTML = "";
  tfoot.innerHTML = "";

  if (!data.length) return;

  const headers = Object.keys(data[0]);

  // HEADER
  const trHead = document.createElement("tr");
  headers.forEach(header => {
    const th = document.createElement("th");
    th.textContent = header;
    th.onclick = () => sortTable(header);

    if (sortState.column === header) {
      th.classList.add(sortState.direction === "asc" ? "sort-asc" : "sort-desc");
    }

    trHead.appendChild(th);
  });
  thead.appendChild(trHead);

  // BODY
  data.forEach(row => {
    const tr = document.createElement("tr");

    headers.forEach(h => {
      const td = document.createElement("td");

      if (typeof row[h] === "number") {
        td.textContent = formatNumber(row[h]);
        td.classList.add("number");
      } else {
        td.textContent = row[h] ?? "";
      }

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  // FOOTER SUM
  let totals = {};
  data.forEach(row => {
    headers.forEach(h => {
      if (typeof row[h] === "number") {
        totals[h] = (totals[h] || 0) + row[h];
      }
    });
  });

  const trFoot = document.createElement("tr");
  headers.forEach((h, i) => {
    const td = document.createElement("td");

    if (i === 0) {
      td.textContent = "‡∏£‡∏ß‡∏°";
    } else if (totals[h]) {
      td.textContent = formatNumber(totals[h]);
      td.classList.add("number");
    }

    trFoot.appendChild(td);
  });

  tfoot.appendChild(trFoot);
}

function sortTable(column) {

  if (sortState.column === column) {
    sortState.direction = sortState.direction === "asc" ? "desc" : "asc";
  } else {
    sortState.column = column;
    sortState.direction = "asc";
  }

  currentData.sort((a, b) => {

    let valA = a[column];
    let valB = b[column];

    if (typeof valA === "number") {
      return sortState.direction === "asc"
        ? valA - valB
        : valB - valA;
    }

    return sortState.direction === "asc"
      ? String(valA).localeCompare(String(valB))
      : String(valB).localeCompare(String(valA));
  });

  renderTable(currentData);
}

async function exportExcel() {

  const btn = exportBtn;
  btn.disabled = true;
  btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á Export...";

  const params = new URLSearchParams({
    start_date: start_date.value,
    end_date: end_date.value,
    province: province.value,
    project_status: project_status.value,
    contract_no: contract_no.value,
    export_all: true
  });

  const res = await fetch(`${API_URL}?${params}`);
  const json = await res.json();

  if (!json.data || json.data.length === 0) {
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    btn.disabled = false;
    btn.textContent = "Export Excel";
    return;
  }

  const ws = XLSX.utils.json_to_sheet(json.data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Due Report");

  const today = new Date().toISOString().slice(0,10);
  XLSX.writeFile(wb, `due_report_${today}.xlsx`);

  btn.disabled = false;
  btn.textContent = "Export Excel";
}

</script>
</body>
</html>