<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Due Report Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{
  margin:0;
  font-family:"Sarabun",system-ui;
  background:linear-gradient(135deg,#667eea,#764ba2);
}
.container{
  max-width:1400px;
  margin:40px auto;
  padding:20px;
}
.card{
  background:#fff;
  border-radius:16px;
  padding:25px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
}
h2{margin-top:0}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:10px;
  margin-bottom:15px;
}
input,select{
  padding:8px;
  border-radius:8px;
  border:1px solid #ddd;
}
button{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}
.btn-search{background:#27ae60;color:#fff}
.btn-show{background:#f39c12;color:#fff}
.btn-export{background:#2980b9;color:#fff}

/* table */
.table-wrapper{
  max-height:500px;
  overflow:auto;
  margin-top:20px;
  border-radius:12px;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
  background:white;
}
th,td{
  padding:6px;
  border-bottom:1px solid #eee;
}
th{
  background:#2c3e50;
  color:#fff;
  cursor:pointer;
  position:sticky;
  top:0;
  z-index:10;
}
td.number{text-align:right}
tfoot td{
  font-weight:bold;
  background:#f4f6f9;
  position:sticky;
  bottom:0;
}
tbody tr:hover{background:#f1f2f6}
</style>
</head>

<body>
<div class="container">
<div class="card">

<h2>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞</h2>

<div class="grid">
  <input type="date" id="start_date">
  <input type="date" id="end_date">

  <select id="province">
    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
  </select>

  <input type="text" id="project_status" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£">
  <input type="text" id="contract_no" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤">

  <div>
    <input type="number" id="start_row" value="1" style="width:60px"> -
    <input type="number" id="end_row" value="100" style="width:60px">
  </div>
</div>

<button class="btn-search" onclick="searchData()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
<button class="btn-show" onclick="showRange()">‡πÅ‡∏™‡∏î‡∏á</button>
<button class="btn-export" onclick="exportExcel()">Export Excel</button>

<div id="info" style="margin-top:10px;font-weight:bold"></div>

<div class="table-wrapper">
<table id="table">
<thead></thead>
<tbody></tbody>
<tfoot></tfoot>
</table>
</div>

</div>
</div>

<script>

const API_URL = "https://api.twferp.click/due-report";
let fullData = [];
let currentView = [];
let sortState = { column:null, direction:"asc" };

const provinces = [
"‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£","‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà","‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ","‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå","‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£",
"‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô","‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ","‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤","‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ","‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó","‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥",
"‡∏ä‡∏∏‡∏°‡∏û‡∏£","‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢","‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà","‡∏ï‡∏£‡∏±‡∏á","‡∏ï‡∏£‡∏≤‡∏î","‡∏ï‡∏≤‡∏Å","‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å",
"‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°","‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°","‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤","‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä","‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå",
"‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ","‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™","‡∏ô‡πà‡∏≤‡∏ô","‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨","‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå","‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ",
"‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå","‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ","‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ","‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤",
"‡∏û‡∏∞‡πÄ‡∏¢‡∏≤","‡∏û‡∏±‡∏á‡∏á‡∏≤","‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á","‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£","‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å","‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ",
"‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå","‡πÅ‡∏û‡∏£‡πà","‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï","‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°","‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£",
"‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô","‡∏¢‡∏∞‡∏•‡∏≤","‡∏¢‡πÇ‡∏™‡∏ò‡∏£","‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î","‡∏£‡∏∞‡∏ô‡∏≠‡∏á","‡∏£‡∏∞‡∏¢‡∏≠‡∏á",
"‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ","‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ","‡∏•‡∏≥‡∏õ‡∏≤‡∏á","‡∏•‡∏≥‡∏û‡∏π‡∏ô","‡πÄ‡∏•‡∏¢","‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©",
"‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£","‡∏™‡∏á‡∏Ç‡∏•‡∏≤","‡∏™‡∏ï‡∏π‡∏•","‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£","‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°",
"‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£","‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß","‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ","‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ","‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢",
"‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ","‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ","‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå","‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢",
"‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π","‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á","‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç","‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ",
"‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå","‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ","‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ"
];

provinces.forEach(p=>{
  const opt=document.createElement("option");
  opt.value=p;
  opt.textContent=p;
  province.appendChild(opt);
});

function formatNumber(num){
  return new Intl.NumberFormat('th-TH').format(num);
}

async function searchData(){

  const params = new URLSearchParams({
    start_date:start_date.value,
    end_date:end_date.value,
    province:province.value,
    project_status:project_status.value,
    contract_no:contract_no.value,
    export_all:true
  });

  const res = await fetch(`${API_URL}?${params}`);
  const json = await res.json();

  fullData = json.data || [];
  showRange();

  info.innerText = `‡∏û‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${formatNumber(fullData.length)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
}

function showRange(){
  const start=parseInt(start_row.value)||1;
  const end=parseInt(end_row.value)||fullData.length;
  currentView=fullData.slice(start-1,end);
  renderTable(currentView);
}

function renderTable(data){

  const thead=table.querySelector("thead");
  const tbody=table.querySelector("tbody");
  const tfoot=table.querySelector("tfoot");

  thead.innerHTML="";
  tbody.innerHTML="";
  tfoot.innerHTML="";

  if(!data.length) return;

  const headers=Object.keys(data[0]);

  const trHead=document.createElement("tr");
  headers.forEach(h=>{
    const th=document.createElement("th");
    th.textContent=h;
    th.onclick=()=>sortTable(h);
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);

  data.forEach(row=>{
    const tr=document.createElement("tr");
    headers.forEach(h=>{
      const td=document.createElement("td");
      if(typeof row[h]==="number"){
        td.textContent=formatNumber(row[h]);
        td.classList.add("number");
      }else{
        td.textContent=row[h]??"";
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  let totals={};
  data.forEach(row=>{
    headers.forEach(h=>{
      if(typeof row[h]==="number"){
        totals[h]=(totals[h]||0)+row[h];
      }
    });
  });

  const trFoot=document.createElement("tr");
  headers.forEach((h,i)=>{
    const td=document.createElement("td");
    if(i===0) td.textContent="‡∏£‡∏ß‡∏°";
    else if(totals[h]){
      td.textContent=formatNumber(totals[h]);
      td.classList.add("number");
    }
    trFoot.appendChild(td);
  });
  tfoot.appendChild(trFoot);
}

function sortTable(col){
  if(sortState.column===col){
    sortState.direction=sortState.direction==="asc"?"desc":"asc";
  }else{
    sortState.column=col;
    sortState.direction="asc";
  }

  currentView.sort((a,b)=>{
    if(typeof a[col]==="number"){
      return sortState.direction==="asc"?a[col]-b[col]:b[col]-a[col];
    }
    return sortState.direction==="asc"
      ? String(a[col]).localeCompare(String(b[col]),'th')
      : String(b[col]).localeCompare(String(a[col]),'th');
  });

  renderTable(currentView);
}

function exportExcel(){
  if(!currentView.length){
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    return;
  }

  const ws=XLSX.utils.json_to_sheet(currentView);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Due Report");

  XLSX.writeFile(wb,"due_report.xlsx");
}

</script>
</body>
</html>