<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>Due Report</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: Sarabun;
      background: #f4f6fb;
      padding: 20px
    }

    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      max-width: 1700px;
      margin: auto
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px
    }

    input,
    select,
    button {
      padding: 8px;
      width: 100%
    }

    button {
      cursor: pointer
    }

    .table-wrap {
      max-height: 600px;
      overflow: auto;
      margin-top: 16px
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 14px
    }

    th {
      background: #eef;
      position: sticky;
      top: 0;
      cursor: pointer
    }

    td {
      text-align: right
    }

    td.left {
      text-align: left
    }

    tfoot td {
      font-weight: bold;
      background: #fafafa;
      position: sticky;
      bottom: 0
    }

    .pager {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px
    }

    .loading {
      color: blue
    }
  </style>
</head>

<body>
  <div class="card">

    <h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞</h2>

    <div class="grid">
      <select id="province">
        <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      </select>

      <select id="project_status">
        <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option>‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</option>
        <option>‡∏õ‡∏¥‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</option>
        <option>‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ</option>
      </select>

      <input id="contract" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
      <div></div>
    </div>

    <div class="grid">
      <input type="date" id="start">
      <input type="date" id="end">
      <button onclick="search()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <button onclick="exportExcel()">Export Excel</button>
    </div>

    <div id="loading" class="loading"></div>
    <div id="result"></div>

    <div class="pager" id="pager" style="display:none">
      <button onclick="firstPage()">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      <button onclick="prevPage()">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
      <span id="pageInfo"></span>
      <button onclick="nextPage()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      <button onclick="lastPage()">‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</button>
    </div>

  </div>

  <script>
    const API = "https://api.twferp.click/due-report";

    const limit = 100; // ‚úÖ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 100
    let offset = 0;
    let total = 0;
    let currentData = [];
    let sortKey = null;
    let sortAsc = true;
    /* ‡πÄ‡∏ï‡∏¥‡∏° 77 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ dropdown */
    const provinces = [
      "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", "‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå", "‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£", "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô",
      "‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤", "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó", "‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥", "‡∏ä‡∏∏‡∏°‡∏û‡∏£",
      "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡∏ï‡∏£‡∏±‡∏á", "‡∏ï‡∏£‡∏≤‡∏î", "‡∏ï‡∏≤‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°",
      "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä", "‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ",
      "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™", "‡∏ô‡πà‡∏≤‡∏ô", "‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨", "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå",
      "‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤", "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "‡∏û‡∏±‡∏á‡∏á‡∏≤", "‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á",
      "‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£", "‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå", "‡πÅ‡∏û‡∏£‡πà", "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï",
      "‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°", "‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£", "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "‡∏¢‡πÇ‡∏™‡∏ò‡∏£", "‡∏¢‡∏∞‡∏•‡∏≤", "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î",
      "‡∏£‡∏∞‡∏ô‡∏≠‡∏á", "‡∏£‡∏∞‡∏¢‡∏≠‡∏á", "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ", "‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ", "‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "‡∏•‡∏≥‡∏û‡∏π‡∏ô",
      "‡πÄ‡∏•‡∏¢", "‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©", "‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£", "‡∏™‡∏á‡∏Ç‡∏•‡∏≤", "‡∏™‡∏ï‡∏π‡∏•", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£",
      "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£", "‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß", "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ",
      "‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢", "‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢",
      "‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π", "‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á", "‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç", "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå",
      "‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ"
    ];

    const provinceSelect = document.getElementById("province");
    provinceSelect.innerHTML = `<option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;

    provinces.forEach(p => {
      provinceSelect.innerHTML += `<option value="${p}">${p}</option>`;
    });
    /* üîπ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á SQL ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ */
    const columns = [
      { key: "province", label: "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", type: "text", align: "left" },
      { key: "district", label: "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠", type: "text", align: "left" },
      { key: "sub_district", label: "‡∏ï‡∏≥‡∏ö‡∏•", type: "text", align: "left" },
      { key: "fiscal_year", label: "‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì", type: "text" },
      { key: "contract_no", label: "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤", type: "text", align: "left" },
      { key: "project_name", label: "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£", type: "text", align: "left" },
      { key: "project_status", label: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£", type: "text", align: "left" },
      { key: "due_date", label: "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞", type: "date" },
      { key: "expected_principle", label: "‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ", type: "number" },
      { key: "interest", label: "‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢", type: "number" },
      { key: "penalty", label: "‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏±‡∏ö", type: "number" },
      { key: "default_interest", label: "‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î", type: "number" },
      { key: "principle_received", label: "‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô", type: "number" },
      { key: "interest_received", label: "‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô", type: "number" },
      { key: "penalty_received", label: "‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô", type: "number" },
      { key: "default_interest_received", label: "‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô", type: "number" },
      { key: "overpaid", label: "‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô", type: "number" }
    ];

    function search() {
      offset = 0;
      loadData();
    }

    function loadData() {
      loading.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
      const q = new URLSearchParams({
        start_date: start.value,
        end_date: end.value,
        province: province.value,
        project_status: project_status.value,
        contract_no: contract.value,
        limit: limit,
        offset: offset
      });

      fetch(API + "?" + q)
        .then(r => r.json())
        .then(d => {
          loading.textContent = "";
          if (!d.found) { result.innerHTML = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; return; }
          total = d.total;
          currentData = d.data;
          renderTable();
          updatePager();
        });
    }

    function renderTable() {
      let html = "<div class='table-wrap'><table><thead><tr>";

      columns.forEach(col => {
        html += `<th onclick="sortTable('${col.key}')">${col.label}</th>`;
      });

      html += "</tr></thead><tbody>";

      currentData.forEach(row => {
        html += "<tr>";
        columns.forEach(col => {
          let val = row[col.key];

          if (col.type === "number") {
            val = val ? Number(val).toLocaleString(undefined, { minimumFractionDigits: 2 }) : "0.00";
          }

          if (col.type === "date" && val) {
            val = formatThaiDate(val);
          }

          html += `<td class="${col.align === 'left' ? 'left' : ''}">${val ?? ""}</td>`;
        });
        html += "</tr>";
      });

      /* üîπ ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤ */
      const sumCols = columns.filter(c => c.type === "number");

      let summary = {};
      sumCols.forEach(c => {
        summary[c.key] = currentData.reduce((s, r) => s + (+r[c.key] || 0), 0);
      });

      html += "</tbody><tfoot><tr>";
      html += `<td colspan="8">‡∏£‡∏ß‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)</td>`;

      columns.slice(8).forEach(col => {
        html += `<td>${summary[col.key].toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>`;
      });

      html += "</tr></tfoot></table></div>";
      result.innerHTML = html;
    }

    /* üî• Sorting ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö text / number / date */
    function sortTable(key) {
      const col = columns.find(c => c.key === key);
      sortAsc = (sortKey === key) ? !sortAsc : true;
      sortKey = key;

      currentData.sort((a, b) => {
        let x = a[key], y = b[key];

        if (col.type === "number") {
          x = +x || 0; y = +y || 0;
          return sortAsc ? x - y : y - x;
        }

        if (col.type === "date") {
          return sortAsc ?
            new Date(x) - new Date(y) :
            new Date(y) - new Date(x);
        }

        return sortAsc ?
          (x || "").localeCompare(y || "") :
          (y || "").localeCompare(x || "");
      });

      renderTable();
    }

    /* üîπ Pagination */
    function updatePager() {
      pager.style.display = "flex";
      const page = Math.floor(offset / limit) + 1;
      const totalPage = Math.ceil(total / limit);
      pageInfo.textContent = `‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ${page} ‡∏à‡∏≤‡∏Å ${totalPage} (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
    }

    function nextPage() { if (offset + limit < total) { offset += limit; loadData(); } }
    function prevPage() { if (offset - limit >= 0) { offset -= limit; loadData(); } }
    function firstPage() { offset = 0; loadData(); }
    function lastPage() { offset = (Math.ceil(total / limit) - 1) * limit; loadData(); }

    /* üîπ Export ‡πÉ‡∏ä‡πâ‡∏´‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á */
    function exportExcel() {
      const q = new URLSearchParams({
        start_date: start.value,
        end_date: end.value,
        province: province.value,
        project_status: project_status.value,
        contract_no: contract.value,
        export_all: true
      });

      fetch(API + "?" + q)
        .then(r => r.json())
        .then(d => {
          const exportData = d.data.map(row => {
            let obj = {};
            columns.forEach(col => {
              obj[col.label] = row[col.key];
            });
            return obj;
          });

          const ws = XLSX.utils.json_to_sheet(exportData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "DueReport");

          const filename =
            `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏Ç‡∏≠‡∏á ${province.value} ${project_status.value} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(start.value)} ‡∏ñ‡∏∂‡∏á ${formatThaiDate(end.value)} ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(new Date())}.xlsx`;

          XLSX.writeFile(wb, filename);
        });
    }

    function formatThaiDate(d) {
      const m = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
      const x = new Date(d);
      return `${x.getDate()} ${m[x.getMonth()]} ${x.getFullYear() + 543}`;
    }
  </script>
</body>

</html>