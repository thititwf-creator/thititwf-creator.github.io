<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Due Report</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family:Sarabun; background:#f4f6fb; padding:20px }
.card { background:#fff; padding:20px; border-radius:12px; max-width:1700px; margin:auto }
.grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px }
input,select,button { padding:8px; width:100% }
button { cursor:pointer }
.table-wrap { max-height:600px; overflow:auto; margin-top:16px }
table { width:100%; border-collapse:collapse }
th,td { border:1px solid #ccc; padding:6px; font-size:14px }
th { background:#eef; position:sticky; top:0; cursor:pointer }
td { text-align:right }
td.left { text-align:left }
tfoot td { font-weight:bold; background:#fafafa; position:sticky; bottom:0 }
.pager { display:flex; gap:10px; align-items:center; margin-top:10px }
.loading { color:blue }
</style>
</head>
<body>
<div class="card">

<h2>รายงานกำหนดชำระ</h2>

<div class="grid">
<select id="province">
<option value="ทั้งหมด">ทั้งหมด</option>
</select>

<select id="project_status">
<option value="ทั้งหมด">ทั้งหมด</option>
<option>เปิดโครงการ</option>
<option>ปิดโครงการ</option>
<option>ระหว่างดำเนินคดี</option>
</select>

<input id="contract" placeholder="เลขที่สัญญา (ไม่บังคับ)">
<div></div>
</div>

<div class="grid">
<input type="date" id="start">
<input type="date" id="end">
<button onclick="search()">ค้นหา</button>
<button onclick="exportExcel()">Export Excel</button>
</div>

<div id="loading" class="loading"></div>
<div id="result"></div>

<div class="pager" id="pager" style="display:none">
<button onclick="firstPage()">หน้าแรก</button>
<button onclick="prevPage()">ก่อนหน้า</button>
<span id="pageInfo"></span>
<button onclick="nextPage()">ถัดไป</button>
<button onclick="lastPage()">หน้าสุดท้าย</button>
</div>

</div>

<script>
const API = "https://api.twferp.click/due-report";
const limit = 100;
let offset = 0;
let total = 0;
let currentData = [];

const provinces = ["กรุงเทพมหานคร","กระบี่","กาญจนบุรี","กาฬสินธุ์","กำแพงเพชร","ขอนแก่น",
"จันทบุรี","ฉะเชิงเทรา","ชลบุรี","ชัยนาท","ชัยภูมิ","ชุมพร","เชียงราย","เชียงใหม่",
"ตรัง","ตราด","ตาก","นครนายก","นครปฐม","นครพนม","นครราชสีมา","นครศรีธรรมราช",
"นครสวรรค์","นนทบุรี","นราธิวาส","น่าน","บึงกาฬ","บุรีรัมย์","ปทุมธานี",
"ประจวบคีรีขันธ์","ปราจีนบุรี","ปัตตานี","พระนครศรีอยุธยา","พะเยา","พังงา",
"พัทลุง","พิจิตร","พิษณุโลก","เพชรบุรี","เพชรบูรณ์","แพร่","ภูเก็ต","มหาสารคาม",
"มุกดาหาร","แม่ฮ่องสอน","ยโสธร","ยะลา","ร้อยเอ็ด","ระนอง","ระยอง","ราชบุรี",
"ลพบุรี","ลำปาง","ลำพูน","เลย","ศรีสะเกษ","สกลนคร","สงขลา","สตูล","สมุทรปราการ",
"สมุทรสงคราม","สมุทรสาคร","สระแก้ว","สระบุรี","สิงห์บุรี","สุโขทัย",
"สุพรรณบุรี","สุราษฎร์ธานี","สุรินทร์","หนองคาย","หนองบัวลำภู","อ่างทอง",
"อำนาจเจริญ","อุดรธานี","อุตรดิตถ์","อุทัยธานี","อุบลราชธานี"];

provinces.forEach(p=>{
  province.innerHTML+=`<option value="${p}">${p}</option>`;
});

function search(){
  offset=0;
  loadData();
}

function loadData(){
  loading.textContent="กำลังโหลด...";
  const q=new URLSearchParams({
    start_date:start.value,
    end_date:end.value,
    province:province.value,
    project_status:project_status.value,
    contract_no:contract.value,
    limit:limit,
    offset:offset
  });

  fetch(API+"?"+q)
  .then(r=>r.json())
  .then(d=>{
    loading.textContent="";
    if(!d.found){ result.innerHTML="ไม่พบข้อมูล"; return; }
    total=d.total;
    currentData=d.data;
    renderTable();
    updatePager();
  });
}

function renderTable(){
  let html="<div class='table-wrap'><table><thead><tr>";
  Object.keys(currentData[0]).forEach(k=>{
    html+=`<th>${k}</th>`;
  });
  html+="</tr></thead><tbody>";

  currentData.forEach(r=>{
    html+="<tr>";
    Object.values(r).forEach(v=>{
      html+=`<td>${typeof v==="number"?v.toLocaleString():v??""}</td>`;
    });
    html+="</tr>";
  });

  html+="</tbody></table></div>";
  result.innerHTML=html;
}

function updatePager(){
  pager.style.display="flex";
  const page=Math.floor(offset/limit)+1;
  const totalPage=Math.ceil(total/limit);
  pageInfo.textContent=`หน้าที่ ${page} จาก ${totalPage} (ทั้งหมด ${total} รายการ)`;
}

function nextPage(){ if(offset+limit<total){ offset+=limit; loadData(); } }
function prevPage(){ if(offset-limit>=0){ offset-=limit; loadData(); } }
function firstPage(){ offset=0; loadData(); }
function lastPage(){ offset=(Math.ceil(total/limit)-1)*limit; loadData(); }

function formatThaiDate(d){
  const m=["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."];
  const x=new Date(d);
  return `${x.getDate()} ${m[x.getMonth()]} ${x.getFullYear()+543}`;
}

function exportExcel(){
  loading.textContent="กำลังเตรียมไฟล์...";
  const q=new URLSearchParams({
    start_date:start.value,
    end_date:end.value,
    province:province.value,
    project_status:project_status.value,
    contract_no:contract.value,
    export_all:true
  });

  fetch(API+"?"+q)
  .then(r=>r.json())
  .then(d=>{
    loading.textContent="";
    const ws=XLSX.utils.json_to_sheet(d.data);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"DueReport");

    const filename=`ข้อมูลกำหนดชำระของ ${province.value} ${project_status.value} วันที่ ${formatThaiDate(start.value)} ถึง ${formatThaiDate(end.value)} ข้อมูล ณ วันที่ ${formatThaiDate(new Date())}.xlsx`;

    XLSX.writeFile(wb,filename);
  });
}
</script>
</body>
</html>