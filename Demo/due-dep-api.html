<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Due Debt</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Sarabun;background:#f4f6fb;padding:30px}
.card{background:#fff;padding:24px;border-radius:12px;max-width:1500px;margin:auto}
input,select,button{padding:8px;width:100%;margin-bottom:8px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
button{cursor:pointer}
.table-wrap{max-height:600px;overflow:auto;margin-top:16px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;font-size:14px}
th{background:#eef;text-align:center;cursor:pointer;position:sticky;top:0}
td{text-align:right}
td.left{text-align:left}
tfoot td{font-weight:bold;background:#fafafa;position:sticky;bottom:0}
.error{color:red;margin-top:10px}
</style>
</head>

<body>
<div class="card">
<h2>ค้นหากำหนดชำระ</h2>

<div class="grid">
  <select id="province" required>
    <option value="">-- เลือกจังหวัด --</option>
    <option value="ทั้งหมด">ทั้งหมด</option>
    <script>
      const provinces = [
        "กรุงเทพมหานคร","กระบี่","กาญจนบุรี","กาฬสินธุ์","กำแพงเพชร","ขอนแก่น",
        "จันทบุรี","ฉะเชิงเทรา","ชลบุรี","ชัยนาท","ชัยภูมิ","ชุมพร",
        "เชียงราย","เชียงใหม่","ตรัง","ตราด","ตาก","นครนายก","นครปฐม",
        "นครพนม","นครราชสีมา","นครศรีธรรมราช","นครสวรรค์","นนทบุรี",
        "นราธิวาส","น่าน","บึงกาฬ","บุรีรัมย์","ปทุมธานี","ประจวบคีรีขันธ์",
        "ปราจีนบุรี","ปัตตานี","พระนครศรีอยุธยา","พะเยา","พังงา","พัทลุง",
        "พิจิตร","พิษณุโลก","เพชรบุรี","เพชรบูรณ์","แพร่","ภูเก็ต",
        "มหาสารคาม","มุกดาหาร","แม่ฮ่องสอน","ยโสธร","ยะลา","ร้อยเอ็ด",
        "ระนอง","ระยอง","ราชบุรี","ลพบุรี","ลำปาง","ลำพูน",
        "เลย","ศรีสะเกษ","สกลนคร","สงขลา","สตูล","สมุทรปราการ",
        "สมุทรสงคราม","สมุทรสาคร","สระแก้ว","สระบุรี","สิงห์บุรี",
        "สุโขทัย","สุพรรณบุรี","สุราษฎร์ธานี","สุรินทร์","หนองคาย",
        "หนองบัวลำภู","อ่างทอง","อำนาจเจริญ","อุดรธานี","อุตรดิตถ์",
        "อุทัยธานี","อุบลราชธานี"
      ];
      provinces.forEach(p=>{
        document.write(`<option value="${p}">${p}</option>`)
      });
    </script>
  </select>

  <select id="project_status" required>
    <option value="">-- เลือกสถานะ --</option>
    <option value="ทั้งหมด">ทั้งหมด</option>
    <option value="เปิดโครงการ">เปิดโครงการ</option>
    <option value="ปิดโครงการ">ปิดโครงการ</option>
    <option value="ระหว่างดำเนินคดี">ระหว่างดำเนินคดี</option>
  </select>

  <input id="contract" placeholder="เลขที่สัญญา (ไม่บังคับ)">
  <div></div>
</div>

<div class="grid">
  <input type="date" id="start">
  <input type="date" id="end">
  <button onclick="search()">ค้นหา</button>
  <button onclick="exportExcel()">Export Excel</button>
</div>

<div id="result"></div>
</div>

<script>
const API = "https://api.twferp.click/due-debt";

function search(){

  if(!start.value || !end.value || !province.value || !project_status.value){
    result.innerHTML = `<div class="error">กรุณาเลือก จังหวัด สถานะ และช่วงวันที่</div>`;
    return;
  }

  const q = new URLSearchParams({
    start_date:start.value,
    end_date:end.value,
    province:province.value,
    project_status:project_status.value
  });

  if(contract.value){
    q.append("ds_number_promise", contract.value);
  }

  fetch(API+"?"+q)
    .then(r=>r.json())
    .then(d=>{
      if(!d.found){
        result.innerHTML = `<div class="error">ไม่พบข้อมูล</div>`;
        return;
      }
      renderTable(d.data);
    });
}

function renderTable(data){
  let html = "<div class='table-wrap'><table><thead><tr>";
  Object.keys(data[0]).forEach(k=>{
    html += `<th>${k}</th>`;
  });
  html += "</tr></thead><tbody>";

  data.forEach(r=>{
    html += "<tr>";
    Object.values(r).forEach(v=>{
      html += `<td>${typeof v==="number"?v.toLocaleString():v}</td>`;
    });
    html += "</tr>";
  });

  html += "</tbody></table></div>";
  result.innerHTML = html;
}
</script>
</body>
</html>