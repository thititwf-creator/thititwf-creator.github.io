<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Due Debt</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Sarabun;background:#f4f6fb;padding:30px}
.card{background:#fff;padding:24px;border-radius:12px;max-width:1300px;margin:auto}
input,button{padding:8px;width:100%;margin-bottom:8px}
button{cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:16px}
th,td{border:1px solid #ccc;padding:6px;font-size:14px}
th{cursor:pointer;background:#eef;text-align:center}
td{text-align:right}
td.left{text-align:left}
tfoot td{font-weight:bold;background:#fafafa}
.error{color:red;margin-top:10px}
</style>
</head>

<body>
<div class="card">
<h2>ค้นหากำหนดชำระ</h2>

<input id="contract" placeholder="เลขที่สัญญา (ไม่บังคับ)">
<input id="province" placeholder="จังหวัด (ไม่บังคับ)">
<input type="date" id="start">
<input type="date" id="end">

<button onclick="search()">ค้นหา</button>
<button onclick="exportExcel()">Export Excel</button>

<div id="result"></div>
</div>

<script>
const API = "https://sculpture-ownership-necessarily-miles.trycloudflare.com/due-debt";
let tableData = [];
let sortKey = null;
let sortAsc = true;

function search(){
  if(!start.value || !end.value){
    result.innerHTML = `<div class="error">กรุณาเลือกช่วงวันที่</div>`;
    return;
  }

  const q = new URLSearchParams({
    start_date: start.value,
    end_date: end.value
  });

  if(contract.value) q.append("ds_number_promise", contract.value);
  if(province.value) q.append("province", province.value);

  fetch(API + "?" + q.toString())
    .then(r=>r.json())
    .then(d=>{
      if(!d.found){
        result.innerHTML = `<div class="error">ไม่พบข้อมูล</div>`;
        return;
      }
      tableData = d.data;
      renderTable(d);
    });
}

function renderTable(d){
  const cols = [
    {k:"province", t:"จังหวัด", left:true},
    {k:"district", t:"อำเภอ", left:true},
    {k:"sub_district", t:"ตำบล", left:true},
    {k:"ds_number_promise", t:"เลขที่สัญญา", left:true},
    {k:"ds_project", t:"ชื่อโครงการ", left:true},
    {k:"due_date", t:"กำหนดชำระ"},
    {k:"expect_principle", t:"เงินต้นที่คาดว่าจะได้"},
    {k:"interest", t:"ดอกเบี้ย"},
    {k:"penalty", t:"เบี้ยปรับ"},
    {k:"re_principle", t:"เงินต้นรับคืน"},
    {k:"re_interest", t:"ดอกเบี้ยรับคืน"},
    {k:"re_penalty", t:"เบี้ยปรับรับคืน"},
  ];

  let html = `<table id="tbl"><thead><tr>`;
  cols.forEach(c=>{
    html += `<th onclick="sortTable('${c.k}')">${c.t}</th>`;
  });
  html += `</tr></thead><tbody>`;

  tableData.forEach(r=>{
    html += `<tr>`;
    cols.forEach(c=>{
      const v = r[c.k] ?? "";
      html += `<td class="${c.left?'left':''}">${typeof v === "number" ? v.toLocaleString() : v}</td>`;
    });
    html += `</tr>`;
  });

  html += `</tbody><tfoot><tr>
    <td colspan="6">รวม</td>
    <td>${d.summary.expect_principle.toLocaleString()}</td>
    <td>${d.summary.interest.toLocaleString()}</td>
    <td>${d.summary.penalty.toLocaleString()}</td>
    <td>${d.summary.re_principle.toLocaleString()}</td>
    <td>${d.summary.re_interest.toLocaleString()}</td>
    <td>${d.summary.re_penalty.toLocaleString()}</td>
  </tr></tfoot></table>`;

  result.innerHTML = html;
}

function sortTable(key){
  sortAsc = sortKey === key ? !sortAsc : true;
  sortKey = key;

  tableData.sort((a,b)=>{
    if(a[key]==null) return 1;
    if(b[key]==null) return -1;
    if(a[key] < b[key]) return sortAsc?-1:1;
    if(a[key] > b[key]) return sortAsc?1:-1;
    return 0;
  });

  renderTable({data:tableData, summary:calcSummary(tableData), found:true});
}

function calcSummary(data){
  const sum = k => data.reduce((s,r)=>s+(Number(r[k])||0),0);
  return {
    expect_principle: sum("expect_principle"),
    interest: sum("interest"),
    penalty: sum("penalty"),
    re_principle: sum("re_principle"),
    re_interest: sum("re_interest"),
    re_penalty: sum("re_penalty"),
  };
}

function exportExcel(){
  const ws = XLSX.utils.json_to_sheet(tableData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "DueDebt");
  XLSX.writeFile(wb, "due_debt.xlsx");
}
</script>
</body>
</html>