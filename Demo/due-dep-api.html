<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Due Debt</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
body{font-family:Sarabun;background:#f4f6fb;padding:30px}
.card{background:#fff;padding:24px;border-radius:12px;max-width:1300px;margin:auto}
input,button{padding:8px;width:100%;margin-bottom:8px}
table{width:100%;border-collapse:collapse;margin-top:16px}
th,td{border:1px solid #ccc;padding:6px;font-size:14px}
th{cursor:pointer;background:#eef}
tfoot td{font-weight:bold;background:#fafafa}
</style>
</head>

<body>
<div class="card">
<h2>ค้นหากำหนดชำระ</h2>

<input id="contract" placeholder="เลขที่สัญญา">
<input id="province" placeholder="จังหวัด">
<input id="district" placeholder="อำเภอ">
<input id="subdistrict" placeholder="ตำบล">
<input type="date" id="start">
<input type="date" id="end">

<button onclick="search()">ค้นหา</button>
<button onclick="exportExcel()">Export Excel</button>

<div id="result"></div>
</div>

<script>
const API = "https://YOUR-API/due-debt/";
let tableData = [];

function search(){
  const q = new URLSearchParams({
    start_date: start.value,
    end_date: end.value,
    ds_number_promise: contract.value,
    province: province.value,
    district: district.value,
    sub_district: subdistrict.value
  });

  fetch(API+"?"+q)
    .then(r=>r.json())
    .then(d=>{
      if(!d.found){ result.innerHTML="ไม่พบข้อมูล"; return;}
      tableData = d.data;
      renderTable(d);
    });
}

function renderTable(d){
  let html=`<table id="tbl"><thead><tr>`;
  const cols=["province","district","sub_district","ds_number_promise","ds_project","due_date",
  "expect_principle","interest","penalty","re_principle","re_interest","re_penalty"];
  cols.forEach(c=>html+=`<th onclick="sort('${c}')">${c}</th>`);
  html+=`</tr></thead><tbody>`;

  d.data.forEach(r=>{
    html+="<tr>";
    cols.forEach(c=>html+=`<td>${r[c]??""}</td>`);
    html+="</tr>";
  });

  html+=`</tbody><tfoot><tr>
    <td colspan="6">รวม</td>
    <td>${d.summary.expect_principle.toLocaleString()}</td>
    <td>${d.summary.interest.toLocaleString()}</td>
    <td>${d.summary.penalty.toLocaleString()}</td>
    <td>${d.summary.re_principle.toLocaleString()}</td>
    <td>${d.summary.re_interest.toLocaleString()}</td>
    <td>${d.summary.re_penalty.toLocaleString()}</td>
  </tr></tfoot></table>`;
  result.innerHTML=html;
}

function exportExcel(){
  const ws = XLSX.utils.json_to_sheet(tableData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "DueDebt");
  XLSX.writeFile(wb, "due_debt.xlsx");
}
</script>
</body>
</html>